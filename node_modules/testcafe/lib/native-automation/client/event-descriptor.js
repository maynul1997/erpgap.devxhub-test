"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const types_1 = require("../types");
// @ts-ignore
const hammerhead_1 = require("../../client/core/deps/hammerhead");
const utils_1 = require("./utils");
const send_request_to_frame_1 = __importDefault(require("../../client/core/utils/send-request-to-frame"));
const dom_1 = require("../../client/core/utils/dom");
const style_1 = require("../../client/core/utils/style");
const messageSandbox = hammerhead_1.eventSandbox.message;
const MOUSE_EVENT_OPTIONS = {
    clickCount: 1,
};
const CALCULATE_TOP_LEFT_POINT_REQUEST_CMD = 'native-automation|calculate-top-left-point|request';
const CALCULATE_TOP_LEFT_POINT_RESPONSE_CMD = 'native-automation|calculate-top-left-point|response';
function getLeftTopPoint(driverIframe) {
    const rect = driverIframe.getBoundingClientRect();
    const borders = (0, style_1.getBordersWidthFloat)(driverIframe);
    const paddings = (0, style_1.getElementPaddingFloat)(driverIframe);
    return {
        x: rect.left + borders.left + paddings.left,
        y: rect.top + borders.top + paddings.top,
    };
}
// Setup cross-iframe interaction
messageSandbox.on(messageSandbox.SERVICE_MSG_RECEIVED_EVENT, async (e) => {
    if (e.message.cmd === CALCULATE_TOP_LEFT_POINT_REQUEST_CMD) {
        const iframeWin = e.source;
        const { x, y } = await calculateIFrameTopLeftPoint();
        const iframe = (0, dom_1.findIframeByWindow)(iframeWin);
        const topLeftPoint = getLeftTopPoint(iframe);
        const responseMsg = {
            cmd: CALCULATE_TOP_LEFT_POINT_RESPONSE_CMD,
            topLeftPoint: {
                x: topLeftPoint.x + x,
                y: topLeftPoint.y + y,
            },
        };
        messageSandbox.sendServiceMsg(responseMsg, iframeWin);
    }
});
async function calculateIFrameTopLeftPoint() {
    if (window !== window.parent) {
        const msg = {
            cmd: CALCULATE_TOP_LEFT_POINT_REQUEST_CMD,
        };
        const { topLeftPoint } = await (0, send_request_to_frame_1.default)(msg, CALCULATE_TOP_LEFT_POINT_RESPONSE_CMD, window.parent);
        return topLeftPoint;
    }
    return { x: 0, y: 0 };
}
class CDPEventDescriptor {
    static _getKeyDownEventText(options) {
        if (options.isNewLine)
            return '\r';
        if (options.keyProperty.length === 1)
            return options.keyProperty;
        return '';
    }
    static createKeyDownOptions(options) {
        const text = CDPEventDescriptor._getKeyDownEventText(options);
        return {
            type: text ? 'keyDown' : 'rawKeyDown',
            modifiers: options.modifiers || 0,
            windowsVirtualKeyCode: options.keyCode,
            key: options.keyProperty,
            text,
        };
    }
    static createKeyUpOptions(options) {
        return {
            type: 'keyUp',
            modifiers: options.modifiers || 0,
            key: options.keyProperty,
            windowsVirtualKeyCode: options.keyCode,
        };
    }
    static async createMouseEventOptions(type, options) {
        const { x, y } = await calculateIFrameTopLeftPoint();
        return hammerhead_1.utils.extend({
            x: options.options.clientX + x,
            y: options.options.clientY + y,
            modifiers: (0, utils_1.calculateKeyModifiersValue)(options.options),
            button: (0, utils_1.calculateMouseButtonValue)(options.options),
            type,
        }, MOUSE_EVENT_OPTIONS);
    }
    static delay(delay) {
        return {
            type: types_1.EventType.Delay,
            options: { delay },
        };
    }
    static keyDown(keyInfo) {
        return {
            type: types_1.EventType.Keyboard,
            options: CDPEventDescriptor.createKeyDownOptions(keyInfo),
        };
    }
    static keyUp(keyInfo) {
        return {
            type: types_1.EventType.Keyboard,
            options: CDPEventDescriptor.createKeyUpOptions(keyInfo),
        };
    }
}
exports.default = CDPEventDescriptor;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtZGVzY3JpcHRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9uYXRpdmUtYXV0b21hdGlvbi9jbGllbnQvZXZlbnQtZGVzY3JpcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG9DQUFxQztBQUVyQyxhQUFhO0FBQ2Isa0VBQXdFO0FBQ3hFLG1DQUFnRjtBQUVoRiwwR0FBK0U7QUFDL0UscURBQWlFO0FBQ2pFLHlEQUE2RjtBQUU3RixNQUFNLGNBQWMsR0FBRyx5QkFBWSxDQUFDLE9BQU8sQ0FBQztBQUU1QyxNQUFNLG1CQUFtQixHQUFHO0lBQ3hCLFVBQVUsRUFBRSxDQUFDO0NBQ2hCLENBQUM7QUFFRixNQUFNLG9DQUFvQyxHQUFJLG9EQUFvRCxDQUFDO0FBQ25HLE1BQU0scUNBQXFDLEdBQUcscURBQXFELENBQUM7QUFFcEcsU0FBUyxlQUFlLENBQUUsWUFBaUI7SUFDdkMsTUFBTSxJQUFJLEdBQU8sWUFBWSxDQUFDLHFCQUFxQixFQUFFLENBQUM7SUFDdEQsTUFBTSxPQUFPLEdBQUksSUFBQSw0QkFBb0IsRUFBQyxZQUFZLENBQUMsQ0FBQztJQUNwRCxNQUFNLFFBQVEsR0FBRyxJQUFBLDhCQUFzQixFQUFDLFlBQVksQ0FBQyxDQUFDO0lBRXRELE9BQU87UUFDSCxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJO1FBQzNDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLEdBQUcsUUFBUSxDQUFDLEdBQUc7S0FDM0MsQ0FBQztBQUNOLENBQUM7QUFFRCxpQ0FBaUM7QUFDakMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsMEJBQTBCLEVBQUUsS0FBSyxFQUFFLENBQUssRUFBRSxFQUFFO0lBQ3pFLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEtBQUssb0NBQW9DLEVB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LE9BQU8sQ0FBQztZQUNyRCxJQUFJO1NBQ1AsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBSyxDQUFFLEtBQWE7UUFDOUIsT0FBTztZQUNILElBQUksRUFBSyxpQkFBUyxDQUFDLEtBQUs7WUFDeEIsT0FBTyxFQUFFLEVBQUUsS0FBSyxFQUFFO1NBQ3JCLENBQUM7SUFDTixDQUFDO0lBRU0sTUFBTSxDQUFDLE9BQU8sQ0FBRSxPQUF5QjtRQUM1QyxPQUFPO1lBQ0gsSUFBSSxFQUFLLGlCQUFTLENBQUMsUUFBUTtZQUMzQixPQUFPLEVBQUUsa0JBQWtCLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDO1NBQzVELENBQUM7SUFDTixDQUFDO0lBRU0sTUFBTSxDQUFDLEtBQUssQ0FBRSxPQUF5QjtRQUMxQyxPQUFPO1lBQ0gsSUFBSSxFQUFLLGlCQUFTLENBQUMsUUFBUTtZQUMzQixPQUFPLEVBQUUsa0JBQWtCLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDO1NBQzFELENBQUM7SUFDTixDQUFDO0NBQ0o7QUFoRUQscUNBZ0VDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRUeXBlIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgU2ltdWxhdGVkS2V5SW5mbyB9IGZyb20gJy4va2V5LXByZXNzL3V0aWxzJztcbi8vIEB0cy1pZ25vcmVcbmltcG9ydCB7IHV0aWxzLCBldmVudFNhbmRib3ggfSBmcm9tICcuLi8uLi9jbGllbnQvY29yZS9kZXBzL2hhbW1lcmhlYWQnO1xuaW1wb3J0IHsgY2FsY3VsYXRlS2V5TW9kaWZpZXJzVmFsdWUsIGNhbGN1bGF0ZU1vdXNlQnV0dG9uVmFsdWUgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IEF4aXNWYWx1ZXNEYXRhIH0gZnJvbSAnLi4vLi4vY2xpZW50L2NvcmUvdXRpbHMvdmFsdWVzL2F4aXMtdmFsdWVzJztcbmltcG9ydCBzZW5kUmVxdWVzdFRvRnJhbWUgZnJvbSAnLi4vLi4vY2xpZW50L2NvcmUvdXRpbHMvc2VuZC1yZXF1ZXN0LXRvLWZyYW1lJztcbmltcG9ydCB7IGZpbmRJZnJhbWVCeVdpbmRvdyB9IGZyb20gJy4uLy4uL2NsaWVudC9jb3JlL3V0aWxzL2RvbSc7XG5pbXBvcnQgeyBnZXRCb3JkZXJzV2lkdGhGbG9hdCwgZ2V0RWxlbWVudFBhZGRpbmdGbG9hdCB9IGZyb20gJy4uLy4uL2NsaWVudC9jb3JlL3V0aWxzL3N0eWxlJztcblxuY29uc3QgbWVzc2FnZVNhbmRib3ggPSBldmVudFNhbmRib3gubWVzc2FnZTtcblxuY29uc3QgTU9VU0VfRVZFTlRfT1BUSU9OUyA9IHtcbiAgICBjbGlja0NvdW50OiAxLFxufTtcblxuY29uc3QgQ0FMQ1VMQVRFX1RPUF9MRUZUX1BPSU5UX1JFUVVFU1RfQ01EICA9ICduYXRpdmUtYXV0b21hdGlvbnxjYWxjdWxhdGUtdG9wLWxlZnQtcG9pbnR8cmVxdWVzdCc7XG5jb25zdCBDQUxDVUxBVEVfVE9QX0xFRlRfUE9JTlRfUkVTUE9OU0VfQ01EID0gJ25hdGl2ZS1hdXRvbWF0aW9ufGNhbGN1bGF0ZS10b3AtbGVmdC1wb2ludHxyZXNwb25zZSc7XG5cbmZ1bmN0aW9uIGdldExlZnRUb3BQb2ludCAoZHJpdmVySWZyYW1lOiBhbnkpOiBBeGlzVmFsdWVzRGF0YTxudW1iZXI+IHtcbiAgICBjb25zdCByZWN0ICAgICA9IGRyaXZlcklmcmFtZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBjb25zdCBib3JkZXJzICA9IGdldEJvcmRlcnNXaWR0aEZsb2F0KGRyaXZlcklmcmFtZSk7XG4gICAgY29uc3QgcGFkZGluZ3MgPSBnZXRFbGVtZW50UGFkZGluZ0Zsb2F0KGRyaXZlcklmcmFtZSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICB4OiByZWN0LmxlZnQgKyBib3JkZXJzLmxlZnQgKyBwYWRkaW5ncy5sZWZ0LFxuICAgICAgICB5OiByZWN0LnRvcCArIGJvcmRlcnMudG9wICsgcGFkZGluZ3MudG9wLFxuICAgIH07XG59XG5cbi8vIFNldHVwIGNyb3NzLWlmcmFtZSBpbnRlcmFjdGlvblxubWVzc2FnZVNhbmRib3gub24obWVzc2FnZVNhbmRib3guU0VSVklDRV9NU0dfUkVDRUlWRURfRVZFTlQsIGFzeW5jIChlOmFueSkgPT4ge1xuICAgIGlmIChlLm1lc3NhZ2UuY21kID09PSBDQUxDVUxBVEVfVE9QX0xFRlRfUE9JTlRfUkVRVUVTVF9DTUQpIHtcbiAgICAgICAgY29uc3QgaWZyYW1lV2luID0gZS5zb3VyY2U7XG5cbiAgICAgICAgY29uc3QgeyB4LCB5IH0gPSBhd2FpdCBjYWxjdWxhdGVJRnJhbWVUb3BMZWZ0UG9pbnQoKTtcblxuICAgICAgICBjb25zdCBpZnJhbWUgPSBmaW5kSWZyYW1lQnlXaW5kb3coaWZyYW1lV2luKTtcbiAgICAgICAgY29uc3QgdG9wTGVmdFBvaW50ID0gZ2V0TGVmdFRvcFBvaW50KGlmcmFtZSk7XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2VNc2cgPSB7XG4gICAgICAgICAgICBjbWQ6ICAgICAgICAgIENBTENVTEFURV9UT1BfTEVGVF9QT0lOVF9SRVNQT05TRV9DTUQsXG4gICAgICAgICAgICB0b3BMZWZ0UG9pbnQ6IHtcbiAgICAgICAgICAgICAgICB4OiB0b3BMZWZ0UG9pbnQueCArIHgsXG4gICAgICAgICAgICAgICAgeTogdG9wTGVmdFBvaW50LnkgKyB5LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfTtcblxuICAgICAgICBtZXNzYWdlU2FuZGJveC5zZW5kU2VydmljZU1zZyhyZXNwb25zZU1zZywgaWZyYW1lV2luKTtcbiAgICB9XG59KTtcblxuYXN5bmMgZnVuY3Rpb24gY2FsY3VsYXRlSUZyYW1lVG9wTGVmdFBvaW50ICgpOiBQcm9taXNlPEF4aXNWYWx1ZXNEYXRhPG51bWJlcj4+IHtcbiAgICBpZiAod2luZG93ICE9PSB3aW5kb3cucGFyZW50KSB7XG4gICAgICAgIGNvbnN0IG1zZzogYW55ID0ge1xuICAgICAgICAgICAgY21kOiBDQUxDVUxBVEVfVE9QX0xFRlRfUE9JTlRfUkVRVUVTVF9DTUQsXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgeyB0b3BMZWZ0UG9pbnQgfSA9IGF3YWl0IHNlbmRSZXF1ZXN0VG9GcmFtZShtc2csIENBTENVTEFURV9UT1BfTEVGVF9QT0lOVF9SRVNQT05TRV9DTUQsIHdpbmRvdy5wYXJlbnQpO1xuXG4gICAgICAgIHJldHVybiB0b3BMZWZ0UG9pbnQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgeDogMCwgeTogMCB9O1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDRFBFdmVudERlc2NyaXB0b3Ige1xuICAgIHByaXZhdGUgc3RhdGljIF9nZXRLZXlEb3duRXZlbnRUZXh0IChvcHRpb25zOiBTaW11bGF0ZWRLZXlJbmZvKTogYW55IHtcbiAgICAgICAgaWYgKG9wdGlvbnMuaXNOZXdMaW5lKVxuICAgICAgICAgICAgcmV0dXJuICdcXHInO1xuXG4gICAgICAgIGlmIChvcHRpb25zLmtleVByb3BlcnR5Lmxlbmd0aCA9PT0gMSlcbiAgICAgICAgICAgIHJldHVybiBvcHRpb25zLmtleVByb3BlcnR5O1xuXG4gICAgICAgIHJldHVybiAnJztcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGNyZWF0ZUtleURvd25PcHRpb25zIChvcHRpb25zOiBTaW11bGF0ZWRLZXlJbmZvKTogYW55IHtcbiAgICAgICAgY29uc3QgdGV4dCA9IENEUEV2ZW50RGVzY3JpcHRvci5fZ2V0S2V5RG93bkV2ZW50VGV4dChvcHRpb25zKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHlwZTogICAgICAgICAgICAgICAgICB0ZXh0ID8gJ2tleURvd24nIDogJ3Jhd0tleURvd24nLFxuICAgICAgICAgICAgbW9kaWZpZXJzOiAgICAgICAgICAgICBvcHRpb25zLm1vZGlmaWVycyB8fCAwLFxuICAgICAgICAgICAgd2luZG93c1ZpcnR1YWxLZXlDb2RlOiBvcHRpb25zLmtleUNvZGUsXG4gICAgICAgICAgICBrZXk6ICAgICAgICAgICAgICAgICAgIG9wdGlvbnMua2V5UHJvcGVydHksXG4gICAgICAgICAgICB0ZXh0LFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlS2V5VXBPcHRpb25zIChvcHRpb25zOiBTaW11bGF0ZWRLZXlJbmZvKTogYW55IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6ICAgICAgICAgICAgICAgICAgJ2tleVVwJyxcbiAgICAgICAgICAgIG1vZGlmaWVyczogICAgICAgICAgICAgb3B0aW9ucy5tb2RpZmllcnMgfHwgMCxcbiAgICAgICAgICAgIGtleTogICAgICAgICAgICAgICAgICAgb3B0aW9ucy5rZXlQcm9wZXJ0eSxcbiAgICAgICAgICAgIHdpbmRvd3NWaXJ0dWFsS2V5Q29kZTogb3B0aW9ucy5rZXlDb2RlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgY3JlYXRlTW91c2VFdmVudE9wdGlvbnMgKHR5cGU6IHN0cmluZywgb3B0aW9uczogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgY29uc3QgeyB4LCB5IH0gPSBhd2FpdCBjYWxjdWxhdGVJRnJhbWVUb3BMZWZ0UG9pbnQoKTtcblxuICAgICAgICByZXR1cm4gdXRpbHMuZXh0ZW5kKHtcbiAgICAgICAgICAgIHg6ICAgICAgICAgb3B0aW9ucy5vcHRpb25zLmNsaWVudFggKyB4LFxuICAgICAgICAgICAgeTogICAgICAgICBvcHRpb25zLm9wdGlvbnMuY2xpZW50WSArIHksXG4gICAgICAgICAgICBtb2RpZmllcnM6IGNhbGN1bGF0ZUtleU1vZGlmaWVyc1ZhbHVlKG9wdGlvbnMub3B0aW9ucyksXG4gICAgICAgICAgICBidXR0b246ICAgIGNhbGN1bGF0ZU1vdXNlQnV0dG9uVmFsdWUob3B0aW9ucy5vcHRpb25zKSxcbiAgICAgICAgICAgIHR5cGUsXG4gICAgICAgIH0sIE1PVVNFX0VWRU5UX09QVElPTlMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZGVsYXkgKGRlbGF5OiBudW1iZXIpOiBhbnkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHlwZTogICAgRXZlbnRUeXBlLkRlbGF5LFxuICAgICAgICAgICAgb3B0aW9uczogeyBkZWxheSB9LFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMga2V5RG93biAoa2V5SW5mbzogU2ltdWxhdGVkS2V5SW5mbyk6IGFueSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0eXBlOiAgICBFdmVudFR5cGUuS2V5Ym9hcmQsXG4gICAgICAgICAgICBvcHRpb25zOiBDRFBFdmVudERlc2NyaXB0b3IuY3JlYXRlS2V5RG93bk9wdGlvbnMoa2V5SW5mbyksXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBrZXlVcCAoa2V5SW5mbzogU2ltdWxhdGVkS2V5SW5mbyk6IGFueSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0eXBlOiAgICBFdmVudFR5cGUuS2V5Ym9hcmQsXG4gICAgICAgICAgICBvcHRpb25zOiBDRFBFdmVudERlc2NyaXB0b3IuY3JlYXRlS2V5VXBPcHRpb25zKGtleUluZm8pLFxuICAgICAgICB9O1xuICAgIH1cbn1cbiJdfQ==