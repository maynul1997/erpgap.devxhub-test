"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const injectables_1 = require("../../assets/injectables");
const debug_loggers_1 = require("../../utils/debug-loggers");
const cdp_1 = require("../utils/cdp");
const constants_1 = require("./constants");
const http_status_codes_1 = require("http-status-codes");
const load_assets_1 = __importDefault(require("../../load-assets"));
const string_1 = require("../utils/string");
const safe_api_1 = require("./safe-api");
const internalRequest = {
    condition: (event) => !event.networkId && event.resourceType !== 'Document',
    handler: async (event, client) => {
        (0, debug_loggers_1.requestPipelineInternalRequestLogger)('%r', event);
        await (0, safe_api_1.safeFailRequest)(client, event);
    },
};
const serviceRequest = {
    condition: (event, options, serviceRoutes) => {
        const url = event.request.url;
        // NOTE: the service 'Error page' should be proxied.
        if (url === serviceRoutes.errorPage1
            || url === serviceRoutes.errorPage2)
            return false;
        return options.serviceDomains.some(domain => url.startsWith(domain));
    },
    handler: async (event, client) => {
        (0, debug_loggers_1.requestPipelineServiceRequestLogger)('%r', event);
        if ((0, cdp_1.isRequest)(event))
            await (0, safe_api_1.safeContinueRequest)(client, event);
        else
            await (0, safe_api_1.safeContinueResponse)(client, event);
    },
};
const defaultFaviconRequest = {
    condition: (event) => {
        const parsedUrl = new URL(event.request.url);
        return parsedUrl.pathname === injectables_1.DEFAULT_FAVICON_PATH;
    },
    handler: async (event, client, options) => {
        (0, debug_loggers_1.requestPipelineLogger)('%r', event);
        if ((0, cdp_1.isRequest)(event))
            await (0, safe_api_1.safeContinueRequest)(client, event);
        else {
            if (event.responseStatusCode === http_status_codes_1.StatusCodes.NOT_FOUND) { // eslint-disable-line no-lonely-if
                const { favIcon } = (0, load_assets_1.default)(options.developmentMode);
                await (0, safe_api_1.safeFulfillRequest)(client, {
                    requestId: event.requestId,
                    responseCode: http_status_codes_1.StatusCodes.OK,
                    responseHeaders: [constants_1.FAVICON_CONTENT_TYPE_HEADER],
                    body: (0, string_1.toBase64String)(favIcon),
                });
            }
            else
                await (0, safe_api_1.safeContinueResponse)(client, event);
        }
    },
};
const SPECIAL_REQUEST_HANDLERS = [
    internalRequest,
    serviceRequest,
    defaultFaviconRequest,
];
function getSpecialRequestHandler(event, options, serviceRoutes) {
    const specialRequestHandler = SPECIAL_REQUEST_HANDLERS.find(h => h.condition(event, options, serviceRoutes));
    return specialRequestHandler ? specialRequestHandler.handler : null;
}
exports.default = getSpecialRequestHandler;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY2lhbC1oYW5kbGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9uYXRpdmUtYXV0b21hdGlvbi9yZXF1ZXN0LXBpcGVsaW5lL3NwZWNpYWwtaGFuZGxlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQSwwREFBZ0U7QUFHaEUsNkRBSW1DO0FBRW5DLHNDQUF5QztBQUN6QywyQ0FBMEQ7QUFDMUQseURBQWdEO0FBQ2hELG9FQUEyQztBQUMzQyw0Q0FBaUQ7QUFDakQseUNBS29CO0FBR3BCLE1BQU0sZUFBZSxHQUFHO0lBQ3BCLFNBQVMsRUFBRSxDQUFDLEtBQXlCLEVBQVcsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVMsSUFBSSxLQUFLLENBQUMsWUFBWSxLQUFLLFVBQVU7SUFDeEcsT0FBTyxFQUFJLEtBQUssRUFBRSxLQUF5QixFQUFFLE1BQW1CLEVBQWlCLEVBQUU7UUFDL0UsSUFBQSxvREFBb0MsRUFBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFbEQsTUFBTSxJQUFBLDBCQUFlLEVBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3pDLENBQUM7Q0FDYyxDQUFDO0FBRXBCLE1BQU0sY0FBYyxHQUFHO0lBQ25CLFNBQVMsRUFBRSxDQUFDLEtBQXlCLEVBQUUsT0FBcUMsRUFBRSxhQUFtQyxFQUFXLEVBQUU7UUFDMUgsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7UUFFOUIsb0RBQW9EO1FBQ3BELElBQUksR0FBRyxLQUFLLGFBQWEsQ0FBQyxVQUFVO2VBQzdCLEdBQUcsS0FBSyxhQUFhLENBQUMsVUFBVTtZQUNuQyxPQUFPLEtBQUssQ0FBQztRQUVqQixPQUFPLE9BQU8sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUFDRCxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQXlCLEVBQUUsTUFBbUIsRUFBaUIsRUFBRTtRQUM3RSxJQUFBLG1EQUFtQyxFQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUVqRCxJQUFJLElBQUEsZUFBUyxFQUFDLEtBQUssQ0FBQztZQUNoQixNQUFNLElBQUEsOEJBQW1CLEVBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDOztZQUV6QyxNQUFNLElBQUEsK0JBQW9CLEVBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2xELENBQUM7Q0FDYyxDQUFDO0FBRXBCLE1BQU0scUJBQXFCLEdBQUc7SUFDMUIsU0FBUyxFQUFFLENBQUMsS0FBeUIsRUFBVyxFQUFFO1FBQzlDLE1BQU0sU0FBUyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFN0MsT0FBTyxTQUFTLENBQUMsUUFBUSxLQUFLLGtDQUFvQixDQUFDO0lBQ3ZELENBQUM7SUFDRCxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQXlCLEVBQUUsTUFBbUIsRUFBRSxPQUFxQyxFQUFpQixFQUFFO1FBQ3BILElBQUEscUNBQXFCLEVBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRW5DLElBQUksSUFBQSxlQUFTLEVBQUMsS0FBSyxDQUFDO1lBQ2hCLE1BQU0sSUFBQSw4QkFBbUIsRUFBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDeEM7WUFDRCxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsS0FBSywrQkFBVyxDQUFDLFNBQVMsRUFBRSxFQUFFLG1DQUFtQztnQkFDekYsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUEscUJBQVUsRUFBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7Z0JBRXhELE1BQU0sSUFBQSw2QkFBa0IsRUFBQyxNQUFNLEVBQUU7b0JBQzdCLFNBQVMsRUFBUSxLQUFLLENBQUMsU0FBUztvQkFDaEMsWUFBWSxFQUFLLCtCQUFXLENBQUMsRUFBRTtvQkFDL0IsZUFBZSxFQUFFLENBQUUsdUNBQTJCLENBQUU7b0JBQ2hELElBQUksRUFBYSxJQUFBLHVCQUFjLEVBQUMsT0FBTyxDQUFDO2lCQUMzQyxDQUFDLENBQUM7YUFDTjs7Z0JBRUcsTUFBTSxJQUFBLCtCQUFvQixFQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNqRDtJQUNMLENBQUM7Q0FDYyxDQUFDO0FBRXBCLE1BQU0sd0JBQXdCLEdBQUc7SUFDN0IsZUFBZTtJQUNmLGNBQWM7SUFDZCxxQkFBcUI7Q0FDeEIsQ0FBQztBQUVGLFNBQXdCLHdCQUF3QixDQUFFLEtBQXlCLEVBQUUsT0FBc0MsRUFBRSxhQUFvQztJQUNySixNQUFNLHFCQUFxQixHQUFHLHdCQUF3QixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDO0lBRTdHLE9BQU8scUJBQXFCLENBQUMsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ3hFLENBQUM7QUFKRCwyQ0FJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm90b2NvbCBmcm9tICdkZXZ0b29scy1wcm90b2NvbCc7XG5pbXBvcnQgUmVxdWVzdFBhdXNlZEV2ZW50ID0gUHJvdG9jb2wuRmV0Y2guUmVxdWVzdFBhdXNlZEV2ZW50O1xuaW1wb3J0IHsgREVGQVVMVF9GQVZJQ09OX1BBVEggfSBmcm9tICcuLi8uLi9hc3NldHMvaW5qZWN0YWJsZXMnO1xuaW1wb3J0IHsgUmVxdWVzdEhhbmRsZXIsIFNwZWNpYWxTZXJ2aWNlUm91dGVzIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgUHJvdG9jb2xBcGkgfSBmcm9tICdjaHJvbWUtcmVtb3RlLWludGVyZmFjZSc7XG5pbXBvcnQge1xuICAgIHJlcXVlc3RQaXBlbGluZUludGVybmFsUmVxdWVzdExvZ2dlcixcbiAgICByZXF1ZXN0UGlwZWxpbmVMb2dnZXIsXG4gICAgcmVxdWVzdFBpcGVsaW5lU2VydmljZVJlcXVlc3RMb2dnZXIsXG59IGZyb20gJy4uLy4uL3V0aWxzL2RlYnVnLWxvZ2dlcnMnO1xuaW1wb3J0IHsgTmF0aXZlQXV0b21hdGlvblNldHVwT3B0aW9ucyB9IGZyb20gJy4uLy4uL3NoYXJlZC90eXBlcyc7XG5pbXBvcnQgeyBpc1JlcXVlc3QgfSBmcm9tICcuLi91dGlscy9jZHAnO1xuaW1wb3J0IHsgRkFWSUNPTl9DT05URU5UX1RZUEVfSEVBREVSIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgU3RhdHVzQ29kZXMgfSBmcm9tICdodHRwLXN0YXR1cy1jb2Rlcyc7XG5pbXBvcnQgbG9hZEFzc2V0cyBmcm9tICcuLi8uLi9sb2FkLWFzc2V0cyc7XG5pbXBvcnQgeyB0b0Jhc2U2NFN0cmluZyB9IGZyb20gJy4uL3V0aWxzL3N0cmluZyc7XG5pbXBvcnQge1xuICAgIHNhZmVDb250aW51ZVJlcXVlc3QsXG4gICAgc2FmZUNvbnRpbnVlUmVzcG9uc2UsXG4gICAgc2FmZUZhaWxSZXF1ZXN0LFxuICAgIHNhZmVGdWxmaWxsUmVxdWVzdCxcbn0gZnJvbSAnLi9zYWZlLWFwaSc7XG5cblxuY29uc3QgaW50ZXJuYWxSZXF1ZXN0ID0ge1xuICAgIGNvbmRpdGlvbjogKGV2ZW50OiBSZXF1ZXN0UGF1c2VkRXZlbnQpOiBib29sZWFuID0+ICFldmVudC5uZXR3b3JrSWQgJiYgZXZlbnQucmVzb3VyY2VUeXBlICE9PSAnRG9jdW1lbnQnLFxuICAgIGhhbmRsZXI6ICAgYXN5bmMgKGV2ZW50OiBSZXF1ZXN0UGF1c2VkRXZlbnQsIGNsaWVudDogUHJvdG9jb2xBcGkpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICAgICAgcmVxdWVzdFBpcGVsaW5lSW50ZXJuYWxSZXF1ZXN0TG9nZ2VyKCclcicsIGV2ZW50KTtcblxuICAgICAgICBhd2FpdCBzYWZlRmFpbFJlcXVlc3QoY2xpZW50LCBldmVudCk7XG4gICAgfSxcbn0gYXMgUmVxdWVzdEhhbmRsZXI7XG5cbmNvbnN0IHNlcnZpY2VSZXF1ZXN0ID0ge1xuICAgIGNvbmRpdGlvbjogKGV2ZW50OiBSZXF1ZXN0UGF1c2VkRXZlbnQsIG9wdGlvbnM6IE5hdGl2ZUF1dG9tYXRpb25TZXR1cE9wdGlvbnMsIHNlcnZpY2VSb3V0ZXM6IFNwZWNpYWxTZXJ2aWNlUm91dGVzKTogYm9vbGVhbiA9PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGV2ZW50LnJlcXVlc3QudXJsO1xuXG4gICAgICAgIC8vIE5PVEU6IHRoZSBzZXJ2aWNlICdFcnJvciBwYWdlJyBzaG91bGQgYmUgcHJveGllZC5cbiAgICAgICAgaWYgKHVybCA9PT0gc2VydmljZVJvdXRlcy5lcnJvclBhZ2UxXG4gICAgICAgICAgICB8fCB1cmwgPT09IHNlcnZpY2VSb3V0ZXMuZXJyb3JQYWdlMilcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICByZXR1cm4gb3B0aW9ucy5zZXJ2aWNlRG9tYWlucy5zb21lKGRvbWFpbiA9PiB1cmwuc3RhcnRzV2l0aChkb21haW4pKTtcbiAgICB9LFxuICAgIGhhbmRsZXI6IGFzeW5jIChldmVudDogUmVxdWVzdFBhdXNlZEV2ZW50LCBjbGllbnQ6IFByb3RvY29sQXBpKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgICAgIHJlcXVlc3RQaXBlbGluZVNlcnZpY2VSZXF1ZXN0TG9nZ2VyKCclcicsIGV2ZW50KTtcblxuICAgICAgICBpZiAoaXNSZXF1ZXN0KGV2ZW50KSlcbiAgICAgICAgICAgIGF3YWl0IHNhZmVDb250aW51ZVJlcXVlc3QoY2xpZW50LCBldmVudCk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGF3YWl0IHNhZmVDb250aW51ZVJlc3BvbnNlKGNsaWVudCwgZXZlbnQpO1xuICAgIH0sXG59IGFzIFJlcXVlc3RIYW5kbGVyO1xuXG5jb25zdCBkZWZhdWx0RmF2aWNvblJlcXVlc3QgPSB7XG4gICAgY29uZGl0aW9uOiAoZXZlbnQ6IFJlcXVlc3RQYXVzZWRFdmVudCk6IGJvb2xlYW4gPT4ge1xuICAgICAgICBjb25zdCBwYXJzZWRVcmwgPSBuZXcgVVJMKGV2ZW50LnJlcXVlc3QudXJsKTtcblxuICAgICAgICByZXR1cm4gcGFyc2VkVXJsLnBhdGhuYW1lID09PSBERUZBVUxUX0ZBVklDT05fUEFUSDtcbiAgICB9LFxuICAgIGhhbmRsZXI6IGFzeW5jIChldmVudDogUmVxdWVzdFBhdXNlZEV2ZW50LCBjbGllbnQ6IFByb3RvY29sQXBpLCBvcHRpb25zOiBOYXRpdmVBdXRvbWF0aW9uU2V0dXBPcHRpb25zKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgICAgIHJlcXVlc3RQaXBlbGluZUxvZ2dlcignJXInLCBldmVudCk7XG5cbiAgICAgICAgaWYgKGlzUmVxdWVzdChldmVudCkpXG4gICAgICAgICAgICBhd2FpdCBzYWZlQ29udGludWVSZXF1ZXN0KGNsaWVudCwgZXZlbnQpO1xuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGlmIChldmVudC5yZXNwb25zZVN0YXR1c0NvZGUgPT09IFN0YXR1c0NvZGVzLk5PVF9GT1VORCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWxvbmVseS1pZlxuICAgICAgICAgICAgICAgIGNvbnN0IHsgZmF2SWNvbiB9ID0gbG9hZEFzc2V0cyhvcHRpb25zLmRldmVsb3BtZW50TW9kZSk7XG5cbiAgICAgICAgICAgICAgICBhd2FpdCBzYWZlRnVsZmlsbFJlcXVlc3QoY2xpZW50LCB7XG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3RJZDogICAgICAgZXZlbnQucmVxdWVzdElkLFxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZUNvZGU6ICAgIFN0YXR1c0NvZGVzLk9LLFxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnM6IFsgRkFWSUNPTl9DT05URU5UX1RZUEVfSEVBREVSIF0sXG4gICAgICAgICAgICAgICAgICAgIGJvZHk6ICAgICAgICAgICAgdG9CYXNlNjRTdHJpbmcoZmF2SWNvbiksXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgYXdhaXQgc2FmZUNvbnRpbnVlUmVzcG9uc2UoY2xpZW50LCBldmVudCk7XG4gICAgICAgIH1cbiAgICB9LFxufSBhcyBSZXF1ZXN0SGFuZGxlcjtcblxuY29uc3QgU1BFQ0lBTF9SRVFVRVNUX0hBTkRMRVJTID0gW1xuICAgIGludGVybmFsUmVxdWVzdCxcbiAgICBzZXJ2aWNlUmVxdWVzdCxcbiAgICBkZWZhdWx0RmF2aWNvblJlcXVlc3QsXG5dO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBnZXRTcGVjaWFsUmVxdWVzdEhhbmRsZXIgKGV2ZW50OiBSZXF1ZXN0UGF1c2VkRXZlbnQsIG9wdGlvbnM/OiBOYXRpdmVBdXRvbWF0aW9uU2V0dXBPcHRpb25zLCBzZXJ2aWNlUm91dGVzPzogU3BlY2lhbFNlcnZpY2VSb3V0ZXMpOiBhbnkge1xuICAgIGNvbnN0IHNwZWNpYWxSZXF1ZXN0SGFuZGxlciA9IFNQRUNJQUxfUkVRVUVTVF9IQU5ETEVSUy5maW5kKGggPT4gaC5jb25kaXRpb24oZXZlbnQsIG9wdGlvbnMsIHNlcnZpY2VSb3V0ZXMpKTtcblxuICAgIHJldHVybiBzcGVjaWFsUmVxdWVzdEhhbmRsZXIgPyBzcGVjaWFsUmVxdWVzdEhhbmRsZXIuaGFuZGxlciA6IG51bGw7XG59XG5cbiJdfQ==