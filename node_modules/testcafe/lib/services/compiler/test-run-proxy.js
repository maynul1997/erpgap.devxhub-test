"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const lodash_1 = require("lodash");
const test_run_tracker_1 = __importDefault(require("../../api/test-run-tracker"));
const test_controller_1 = __importDefault(require("../../api/test-controller"));
const observed_callsites_storage_1 = __importDefault(require("../../test-run/observed-callsites-storage"));
const warning_log_1 = __importDefault(require("../../notifications/warning-log"));
const type_1 = __importDefault(require("../../test-run/commands/type"));
const base_1 = require("../../test-run/commands/base");
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const re_executable_promise_1 = __importDefault(require("../../utils/re-executable-promise"));
const async_event_emitter_1 = __importDefault(require("../../utils/async-event-emitter"));
const marker_symbol_1 = __importDefault(require("../../test-run/marker-symbol"));
const constants_1 = require("../../test-run/execute-js-expression/constants");
const marker_1 = require("../serialization/replicator/transforms/function-marker-transform/marker");
const get_fn_1 = __importDefault(require("../../assertions/get-fn"));
const thennable_1 = require("../../utils/thennable");
const marker_2 = require("../serialization/replicator/transforms/promise-marker-transform/marker");
const observation_1 = require("../../test-run/commands/observation");
class TestRunProxy extends async_event_emitter_1.default {
    constructor({ dispatcher, id, test, options, browser, activeWindowId, messageBus, isNativeAutomation }) {
        super();
        this.debugging = false;
        this[marker_symbol_1.default] = true;
        this.dispatcher = dispatcher;
        this.id = id;
        this.test = test;
        this.ctx = Object.create(null);
        this.fixtureCtx = Object.create(null);
        this._options = options;
        this.browser = browser;
        this.assertionCommands = new Map();
        this.switchToWindowByPredicateCommands = new Map();
        this.asyncJsExpressionCallsites = new Map();
        this.controller = new test_controller_1.default(this);
        this.observedCallsites = new observed_callsites_storage_1.default();
        this.warningLog = new warning_log_1.default(null, warning_log_1.default.createAddWarningCallback(messageBus));
        this.disableMultipleWindows = options.disableMultipleWindows;
        this.activeWindowId = activeWindowId;
        this._isNativeAutomation = isNativeAutomation;
        test_run_tracker_1.default.addActiveTestRun(this);
        this._initializeRequestHooks();
    }
    _initializeRequestHooks() {
        this.test.requestHooks.forEach(this._attachWarningLog, this);
    }
    _attachWarningLog(hook) {
        hook._warningLog = this.warningLog;
    }
    _detachWarningLog(hook) {
        hook._warningLog = null;
    }
    _storeAssertionCommand(command) {
        command.id = (0, testcafe_hammerhead_1.generateUniqueId)();
        this.assertionCommands.set(command.id, command);
    }
    _storeSwitchToWindowByPredicateCommand(command) {
        command.id = (0, testcafe_hammerhead_1.generateUniqueId)();
        this.switchToWindowByPredicateCommands.set(command.id, command);
    }
    _handleAssertionCommand(command) {
        if ((0, lodash_1.isFunction)(command.actual)) {
            command.originActual = command.actual;
            command.actual = new marker_1.FunctionMarker();
            this._storeAssertionCommand(command);
        }
        else if (command.actual instanceof re_executable_promise_1.default)
            this._storeAssertionCommand(command);
        else if ((0, thennable_1.isThennable)(command.actual)) {
            command.originActual = command.actual;
            command.actual = new marker_2.PromiseMarker();
            this._storeAssertionCommand(command);
        }
    }
    _handleExecuteClientFunctionCommandBase(command) {
        command.esmRuntime = this.test.esmRuntime;
    }
    _storeActionCallsitesForExecutedAsyncJsExpression(callsite) {
        // @ts-ignore
        if ((callsite === null || callsite === void 0 ? void 0 : callsite.filename) !== constants_1.ERROR_FILENAME)
            return;
        const id = (0, testcafe_hammerhead_1.generateUniqueId)();
        // @ts-ignore
        callsite.id = id;
        this.asyncJsExpressionCallsites.set(id, callsite);
    }
    async executeCommand(command, callsite) {
        if (command instanceof base_1.ActionCommandBase && callsite)
            this._storeActionCallsitesForExecutedAsyncJsExpression(callsite);
        if (command.type === type_1.default.assertion)
            this._handleAssertionCommand(command);
        else if (command.type === type_1.default.useRole)
            this.dispatcher.onRoleAppeared(command.role);
        else if (command.type === type_1.default.switchToWindowByPredicate)
            this._storeSwitchToWindowByPredicateCommand(command);
        else if (command instanceof observation_1.ExecuteClientFunctionCommandBase)
            this._handleExecuteClientFunctionCommandBase(command);
        return this.dispatcher.executeCommand({
            command,
            callsite,
            id: this.id,
        });
    }
    executeCommandSync(command, callsite) {
        if (command.type === type_1.default.assertion)
            this._handleAssertionCommand(command);
        else if (command.type === type_1.default.useRole)
            this.dispatcher.onRoleAppeared(command.role);
        return this.dispatcher.executeCommandSync({
            command,
            callsite,
            id: this.id,
        });
    }
    async addRequestHook(hook) {
        if (this.test.requestHooks.includes(hook))
            return;
        this.test.requestHooks.push(hook);
        this._attachWarningLog(hook);
        await this.dispatcher.addRequestEventListeners({
            hookId: hook.id,
            hookClassName: hook._className,
            rules: hook._requestFilterRules,
        });
    }
    async removeRequestHook(hook) {
        if (!this.test.requestHooks.includes(hook))
            return;
        (0, lodash_1.pull)(this.test.requestHooks, hook);
        this._detachWarningLog(hook);
        await this.dispatcher.removeRequestEventListeners({ rules: hook._requestFilterRules });
    }
    async getAssertionActualValue(commandId) {
        const command = this.assertionCommands.get(commandId);
        return command.actual._reExecute();
    }
    async executeAssertionFn(commandId) {
        const command = this.assertionCommands.get(commandId);
        command.actual = command.originActual;
        const fn = (0, get_fn_1.default)(command);
        return await fn();
    }
    restoreOriginCallsiteForError(err) {
        err.errCallsite = this.asyncJsExpressionCallsites.get(err.errCallsite.id);
        this.asyncJsExpressionCallsites.clear();
    }
    checkWindow(commandId, { title, url }) {
        const command = this.switchToWindowByPredicateCommands.get(commandId);
        return command.checkWindow({ title, url });
    }
    isNativeAutomation() {
        return this._isNativeAutomation;
    }
}
exports.default = TestRunProxy;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1ydW4tcHJveHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvY29tcGlsZXIvdGVzdC1ydW4tcHJveHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxtQ0FBMEM7QUFDMUMsa0ZBQXdEO0FBRXhELGdGQUF1RDtBQUN2RCwyR0FBaUY7QUFDakYsa0ZBQXlEO0FBR3pELHdFQUF3RDtBQUN4RCx1REFBOEU7QUFJOUUsNkRBQXVEO0FBU3ZELDhGQUFvRTtBQUNwRSwwRkFBZ0U7QUFDaEUsaUZBQXlEO0FBQ3pELDhFQUFnRjtBQUVoRixvR0FBeUc7QUFDekcscUVBQTRDO0FBQzVDLHFEQUFvRDtBQUNwRCxtR0FBdUc7QUFDdkcscUVBQXVGO0FBRXZGLE1BQU0sWUFBYSxTQUFRLDZCQUFpQjtJQW9CeEMsWUFBb0IsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxVQUFVLEVBQUUsa0JBQWtCLEVBQW9CO1FBQzVILEtBQUssRUFBRSxDQUFDO1FBYkwsY0FBUyxHQUFHLEtBQUssQ0FBQztRQWVyQixJQUFJLENBQUMsdUJBQWEsQ0FBQyxHQUFzQixJQUFJLENBQUM7UUFDOUMsSUFBSSxDQUFDLFVBQVUsR0FBMEIsVUFBVSxDQUFDO1FBQ3BELElBQUksQ0FBQyxFQUFFLEdBQWtDLEVBQUUsQ0FBQztRQUM1QyxJQUFJLENBQUMsSUFBSSxHQUFnQyxJQUFJLENBQUM7UUFDOUMsSUFBSSxDQUFDLEdBQUcsR0FBaUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsVUFBVSxHQUEwQixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxRQUFRLEdBQTRCLE9BQU8sQ0FBQztRQUNqRCxJQUFJLENBQUMsT0FBTyxHQUE2QixPQUFPLENBQUM7UUFDakQsSUFBSSxDQUFDLGlCQUFpQixHQUFtQixJQUFJLEdBQUcsRUFBNEIsQ0FBQztRQUM3RSxJQUFJLENBQUMsaUNBQWlDLEdBQUcsSUFBSSxHQUFHLEVBQTRDLENBQUM7UUFDN0YsSUFBSSxDQUFDLDBCQUEwQixHQUFVLElBQUksR0FBRyxFQUEwQixDQUFDO1FBQzNFLElBQUksQ0FBQyxVQUFVLEdBQTBCLElBQUkseUJBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNsRSxJQUFJLENBQUMsaUJBQWlCLEdBQW1CLElBQUksb0NBQXdCLEVBQUUsQ0FBQztRQUN4RSxJQUFJLENBQUMsVUFBVSxHQUEwQixJQUFJLHFCQUFVLENBQUMsSUFBSSxFQUFFLHFCQUFVLENBQUMsd0JBQXdCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUMvRyxJQUFJLENBQUMsc0JBQXNCLEdBQWMsT0FBTyxDQUFDLHNCQUFpQyxDQUFDO1FBQ25GLElBQUksQ0FBQyxjQUFjLEdBQXNCLGNBQWMsQ0FBQztRQUN4RCxJQUFJLENBQUMsbUJBQW1CLEdBQWlCLGtCQUFrQixDQUFDO1FBRTVELDBCQUFjLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFdEMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUM7SUFDbkMsQ0FBQztJQUVPLHVCQUF1QjtRQUMzQixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFFTyxpQkFBaUIsQ0FBRSxJQUFpQjtRQUN4QyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDdkMsQ0FBQztJQUVPLGlCQUFpQixDQUFFLElBQWlCO1FBQ3hDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQzVCLENBQUM7SUFFTyxzQkFBc0IsQ0FBRSxPQUF5QjtRQUNyRCxPQUFPLENBQUMsRUFBRSxHQUFHLElBQUEsc0NBQWdCLEdBQUUsQ0FBQztRQUVoQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVPLHNDQUFzQyxDQUFFLE9BQXlDO1FBQ3JGLE9BQU8sQ0FBQyxFQUFFLEdBQUcsSUFBQSxzQ0FBZ0IsR0FBRSxDQUFDO1FBRWhDLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBRU8sdUJBQXVCLENBQUUsT0FBeUI7UUFDdEQsSUFBSSxJQUFBLG1CQUFVLEVBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQzVCLE9BQU8sQ0FBQyxZQUFZLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztZQUN0QyxPQUFPLENBQUMsTUFBTSxHQUFTLElBQUksdUJBQWMsRUFBRSxDQUFDO1lBRTVDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN4QzthQUNJLElBQUksT0FBTyxDQUFDLE1BQU0sWUFBWSwrQkFBbUI7WUFDbEQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBRXBDLElBQUksSUFBQSx1QkFBVyxFQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNsQyxPQUFPLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDdEMsT0FBTyxDQUFDLE1BQU0sR0FBUyxJQUFJLHNCQUFhLEVBQUUsQ0FBQztZQUUzQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDeEM7SUFDTCxDQUFDO0lBRU8sdUNBQXVDLENBQUUsT0FBeUM7UUFDdEYsT0FBTyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUM5QyxDQUFDO0lBRU8saURBQWlELENBQUUsUUFBd0I7UUFDL0UsYUFBYTtRQUNiLElBQUksQ0FBQSxRQUFRLGFBQVIsUUFBUSx1QkFBUixRQUFRLENBQUUsUUFBUSxNQUFLLDBCQUFjO1lBQ3JDLE9BQU87UUFFWCxNQUFNLEVBQUUsR0FBRyxJQUFBLHNDQUFnQixHQUFFLENBQUM7UUFFOUIsYUFBYTtRQUNiLFFBQVEsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBRWpCLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLFFBQTBCLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRU0sS0FBSyxDQUFDLGNBQWMsQ0FBRSxPQUF3QyxFQUFFLFFBQWtDO1FBQ3JHLElBQUksT0FBTyxZQUFZLHdCQUFpQixJQUFJLFFBQVE7WUFDaEQsSUFBSSxDQUFDLGlEQUFpRCxDQUFDLFFBQTBCLENBQUMsQ0FBQztRQUV2RixJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssY0FBWSxDQUFDLFNBQVM7WUFDdkMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQTJCLENBQUMsQ0FBQzthQUN6RCxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssY0FBWSxDQUFDLE9BQU87WUFDMUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUUsT0FBMEIsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNoRSxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssY0FBWSxDQUFDLHlCQUF5QjtZQUM1RCxJQUFJLENBQUMsc0NBQXNDLENBQUMsT0FBMkMsQ0FBQyxDQUFDO2FBQ3hGLElBQUksT0FBTyxZQUFZLDhDQUFnQztZQUN4RCxJQUFJLENBQUMsdUNBQXVDLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFMUQsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQztZQUNsQyxPQUFPO1lBQ1AsUUFBUTtZQUNSLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRTtTQUNkLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTSxrQkFBa0IsQ0FBRSxPQUFvQixFQUFFLFFBQXdCO1FBQ3JFLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxjQUFZLENBQUMsU0FBUztZQUN2QyxJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBMkIsQ0FBQyxDQUFDO2FBQ3pELElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxjQUFZLENBQUMsT0FBTztZQUMxQyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBRSxPQUEwQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXJFLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQztZQUN0QyxPQUFPO1lBQ1AsUUFBUTtZQUNSLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRTtTQUNkLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTSxLQUFLLENBQUMsY0FBYyxDQUFFLElBQWlCO1FBQzFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztZQUNyQyxPQUFPO1FBRVgsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU3QixNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsd0JBQXdCLENBQUM7WUFDM0MsTUFBTSxFQUFTLElBQUksQ0FBQyxFQUFFO1lBQ3RCLGFBQWEsRUFBRSxJQUFJLENBQUMsVUFBVTtZQUM5QixLQUFLLEVBQVUsSUFBSSxDQUFDLG1CQUFtQjtTQUMxQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0sS0FBSyxDQUFDLGlCQUFpQixDQUFFLElBQWlCO1FBQzdDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQ3RDLE9BQU87UUFFWCxJQUFBLGFBQUksRUFBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFN0IsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLDJCQUEyQixDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUM7SUFDM0YsQ0FBQztJQUVNLEtBQUssQ0FBQyx1QkFBdUIsQ0FBRSxTQUFpQjtRQUNuRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBcUIsQ0FBQztRQUUxRSxPQUFRLE9BQU8sQ0FBQyxNQUE4QixDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ2hFLENBQUM7SUFFTSxLQUFLLENBQUMsa0JBQWtCLENBQUUsU0FBaUI7UUFDOUMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQXFCLENBQUM7UUFFMUUsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDO1FBRXRDLE1BQU0sRUFBRSxHQUFHLElBQUEsZ0JBQUssRUFBQyxPQUFPLENBQUMsQ0FBQztRQUUxQixPQUFPLE1BQU0sRUFBRSxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVNLDZCQUE2QixDQUFFLEdBQXdDO1FBQzFFLEdBQUcsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLDBCQUEwQixDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTFFLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUM1QyxDQUFDO0lBRU0sV0FBVyxDQUFFLFNBQWlCLEVBQUUsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUE0QjtRQUMzRSxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsaUNBQWlDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBcUMsQ0FBQztRQUUxRyxPQUFPLE9BQU8sQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRU0sa0JBQWtCO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDO0lBQ3BDLENBQUM7Q0FDSjtBQUVELGtCQUFlLFlBQVksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHB1bGwsIGlzRnVuY3Rpb24gfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHRlc3RSdW5UcmFja2VyIGZyb20gJy4uLy4uL2FwaS90ZXN0LXJ1bi10cmFja2VyJztcbmltcG9ydCB7IFRlc3RSdW5EaXNwYXRjaGVyUHJvdG9jb2wgfSBmcm9tICcuL3Byb3RvY29sJztcbmltcG9ydCBUZXN0Q29udHJvbGxlciBmcm9tICcuLi8uLi9hcGkvdGVzdC1jb250cm9sbGVyJztcbmltcG9ydCBPYnNlcnZlZENhbGxzaXRlc1N0b3JhZ2UgZnJvbSAnLi4vLi4vdGVzdC1ydW4vb2JzZXJ2ZWQtY2FsbHNpdGVzLXN0b3JhZ2UnO1xuaW1wb3J0IFdhcm5pbmdMb2cgZnJvbSAnLi4vLi4vbm90aWZpY2F0aW9ucy93YXJuaW5nLWxvZyc7XG5pbXBvcnQgeyBBc3NlcnRpb25Db21tYW5kIH0gZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvYXNzZXJ0aW9uJztcbmltcG9ydCB7IERpY3Rpb25hcnkgfSBmcm9tICcuLi8uLi9jb25maWd1cmF0aW9uL2ludGVyZmFjZXMnO1xuaW1wb3J0IENPTU1BTkRfVFlQRSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy90eXBlJztcbmltcG9ydCB7IEFjdGlvbkNvbW1hbmRCYXNlLCBDb21tYW5kQmFzZSB9IGZyb20gJy4uLy4uL3Rlc3QtcnVuL2NvbW1hbmRzL2Jhc2UnO1xuaW1wb3J0IHsgVGVzdFJ1blByb3h5SW5pdCB9IGZyb20gJy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IFRlc3QgZnJvbSAnLi4vLi4vYXBpL3N0cnVjdHVyZS90ZXN0JztcbmltcG9ydCBSZXF1ZXN0SG9vayBmcm9tICcuLi8uLi9hcGkvcmVxdWVzdC1ob29rcy9ob29rJztcbmltcG9ydCB7IGdlbmVyYXRlVW5pcXVlSWQgfSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcbmltcG9ydCB7IENhbGxzaXRlUmVjb3JkIH0gZnJvbSAnY2FsbHNpdGUtcmVjb3JkJztcblxuaW1wb3J0IHtcbiAgICBDaGVja1dpbmRvd1ByZWRpY2F0ZURhdGEsXG4gICAgU3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmQsXG4gICAgVXNlUm9sZUNvbW1hbmQsXG59IGZyb20gJy4uLy4uL3Rlc3QtcnVuL2NvbW1hbmRzL2FjdGlvbnMnO1xuXG5pbXBvcnQgUmVFeGVjdXRhYmxlUHJvbWlzZSBmcm9tICcuLi8uLi91dGlscy9yZS1leGVjdXRhYmxlLXByb21pc2UnO1xuaW1wb3J0IEFzeW5jRXZlbnRFbWl0dGVyIGZyb20gJy4uLy4uL3V0aWxzL2FzeW5jLWV2ZW50LWVtaXR0ZXInO1xuaW1wb3J0IHRlc3RSdW5NYXJrZXIgZnJvbSAnLi4vLi4vdGVzdC1ydW4vbWFya2VyLXN5bWJvbCc7XG5pbXBvcnQgeyBFUlJPUl9GSUxFTkFNRSB9IGZyb20gJy4uLy4uL3Rlc3QtcnVuL2V4ZWN1dGUtanMtZXhwcmVzc2lvbi9jb25zdGFudHMnO1xuaW1wb3J0IHsgVW5jYXVnaHRUZXN0Q2FmZUVycm9ySW5DdXN0b21TY3JpcHQgfSBmcm9tICcuLi8uLi9lcnJvcnMvdGVzdC1ydW4nO1xuaW1wb3J0IHsgRnVuY3Rpb25NYXJrZXIgfSBmcm9tICcuLi9zZXJpYWxpemF0aW9uL3JlcGxpY2F0b3IvdHJhbnNmb3Jtcy9mdW5jdGlvbi1tYXJrZXItdHJhbnNmb3JtL21hcmtlcic7XG5pbXBvcnQgZ2V0Rm4gZnJvbSAnLi4vLi4vYXNzZXJ0aW9ucy9nZXQtZm4nO1xuaW1wb3J0IHsgaXNUaGVubmFibGUgfSBmcm9tICcuLi8uLi91dGlscy90aGVubmFibGUnO1xuaW1wb3J0IHsgUHJvbWlzZU1hcmtlciB9IGZyb20gJy4uL3NlcmlhbGl6YXRpb24vcmVwbGljYXRvci90cmFuc2Zvcm1zL3Byb21pc2UtbWFya2VyLXRyYW5zZm9ybS9tYXJrZXInO1xuaW1wb3J0IHsgRXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZEJhc2UgfSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9vYnNlcnZhdGlvbic7XG5cbmNsYXNzIFRlc3RSdW5Qcm94eSBleHRlbmRzIEFzeW5jRXZlbnRFbWl0dGVyIHtcbiAgICBwcml2YXRlIFt0ZXN0UnVuTWFya2VyXTogYm9vbGVhbjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgaWQ6IHN0cmluZztcbiAgICBwdWJsaWMgcmVhZG9ubHkgdGVzdDogVGVzdDtcbiAgICBwdWJsaWMgcmVhZG9ubHkgY29udHJvbGxlcjogVGVzdENvbnRyb2xsZXI7XG4gICAgcHVibGljIHJlYWRvbmx5IG9ic2VydmVkQ2FsbHNpdGVzOiBPYnNlcnZlZENhbGxzaXRlc1N0b3JhZ2U7XG4gICAgcHVibGljIHJlYWRvbmx5IHdhcm5pbmdMb2c6IFdhcm5pbmdMb2c7XG4gICAgcHVibGljIGZpeHR1cmVDdHg6IG9iamVjdDtcbiAgICBwdWJsaWMgZGVidWdnaW5nID0gZmFsc2U7XG4gICAgcHJpdmF0ZSByZWFkb25seSBkaXNwYXRjaGVyOiBUZXN0UnVuRGlzcGF0Y2hlclByb3RvY29sO1xuICAgIHB1YmxpYyBjdHg6IG9iamVjdDtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9vcHRpb25zOiBEaWN0aW9uYXJ5PE9wdGlvblZhbHVlPjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFzc2VydGlvbkNvbW1hbmRzOiBNYXA8c3RyaW5nLCBBc3NlcnRpb25Db21tYW5kPjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kczogTWFwPHN0cmluZywgU3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmQ+O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgYXN5bmNKc0V4cHJlc3Npb25DYWxsc2l0ZXM6IE1hcDxzdHJpbmcsIENhbGxzaXRlUmVjb3JkPjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9pc05hdGl2ZUF1dG9tYXRpb246IGJvb2xlYW47XG4gICAgcHVibGljIHJlYWRvbmx5IGJyb3dzZXI6IEJyb3dzZXI7XG4gICAgcHVibGljIHJlYWRvbmx5IGRpc2FibGVNdWx0aXBsZVdpbmRvd3M6IGJvb2xlYW47XG4gICAgcHVibGljIGFjdGl2ZVdpbmRvd0lkOiBudWxsIHwgc3RyaW5nO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yICh7IGRpc3BhdGNoZXIsIGlkLCB0ZXN0LCBvcHRpb25zLCBicm93c2VyLCBhY3RpdmVXaW5kb3dJZCwgbWVzc2FnZUJ1cywgaXNOYXRpdmVBdXRvbWF0aW9uIH06IFRlc3RSdW5Qcm94eUluaXQpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzW3Rlc3RSdW5NYXJrZXJdICAgICAgICAgICAgICAgICAgICA9IHRydWU7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hlciAgICAgICAgICAgICAgICAgICAgICAgID0gZGlzcGF0Y2hlcjtcbiAgICAgICAgdGhpcy5pZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBpZDtcbiAgICAgICAgdGhpcy50ZXN0ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0ZXN0O1xuICAgICAgICB0aGlzLmN0eCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgICAgIHRoaXMuZml4dHVyZUN0eCAgICAgICAgICAgICAgICAgICAgICAgID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICAgICAgdGhpcy5fb3B0aW9ucyAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zO1xuICAgICAgICB0aGlzLmJyb3dzZXIgICAgICAgICAgICAgICAgICAgICAgICAgICA9IGJyb3dzZXI7XG4gICAgICAgIHRoaXMuYXNzZXJ0aW9uQ29tbWFuZHMgICAgICAgICAgICAgICAgID0gbmV3IE1hcDxzdHJpbmcsIEFzc2VydGlvbkNvbW1hbmQ+KCk7XG4gICAgICAgIHRoaXMuc3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmRzID0gbmV3IE1hcDxzdHJpbmcsIFN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kPigpO1xuICAgICAgICB0aGlzLmFzeW5jSnNFeHByZXNzaW9uQ2FsbHNpdGVzICAgICAgICA9IG5ldyBNYXA8c3RyaW5nLCBDYWxsc2l0ZVJlY29yZD4oKTtcbiAgICAgICAgdGhpcy5jb250cm9sbGVyICAgICAgICAgICAgICAgICAgICAgICAgPSBuZXcgVGVzdENvbnRyb2xsZXIodGhpcyk7XG4gICAgICAgIHRoaXMub2JzZXJ2ZWRDYWxsc2l0ZXMgICAgICAgICAgICAgICAgID0gbmV3IE9ic2VydmVkQ2FsbHNpdGVzU3RvcmFnZSgpO1xuICAgICAgICB0aGlzLndhcm5pbmdMb2cgICAgICAgICAgICAgICAgICAgICAgICA9IG5ldyBXYXJuaW5nTG9nKG51bGwsIFdhcm5pbmdMb2cuY3JlYXRlQWRkV2FybmluZ0NhbGxiYWNrKG1lc3NhZ2VCdXMpKTtcbiAgICAgICAgdGhpcy5kaXNhYmxlTXVsdGlwbGVXaW5kb3dzICAgICAgICAgICAgPSBvcHRpb25zLmRpc2FibGVNdWx0aXBsZVdpbmRvd3MgYXMgYm9vbGVhbjtcbiAgICAgICAgdGhpcy5hY3RpdmVXaW5kb3dJZCAgICAgICAgICAgICAgICAgICAgPSBhY3RpdmVXaW5kb3dJZDtcbiAgICAgICAgdGhpcy5faXNOYXRpdmVBdXRvbWF0aW9uICAgICAgICAgICAgICAgPSBpc05hdGl2ZUF1dG9tYXRpb247XG5cbiAgICAgICAgdGVzdFJ1blRyYWNrZXIuYWRkQWN0aXZlVGVzdFJ1bih0aGlzKTtcblxuICAgICAgICB0aGlzLl9pbml0aWFsaXplUmVxdWVzdEhvb2tzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfaW5pdGlhbGl6ZVJlcXVlc3RIb29rcyAoKTogdm9pZCB7XG4gICAgICAgIHRoaXMudGVzdC5yZXF1ZXN0SG9va3MuZm9yRWFjaCh0aGlzLl9hdHRhY2hXYXJuaW5nTG9nLCB0aGlzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9hdHRhY2hXYXJuaW5nTG9nIChob29rOiBSZXF1ZXN0SG9vayk6IHZvaWQge1xuICAgICAgICBob29rLl93YXJuaW5nTG9nID0gdGhpcy53YXJuaW5nTG9nO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2RldGFjaFdhcm5pbmdMb2cgKGhvb2s6IFJlcXVlc3RIb29rKTogdm9pZCB7XG4gICAgICAgIGhvb2suX3dhcm5pbmdMb2cgPSBudWxsO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3N0b3JlQXNzZXJ0aW9uQ29tbWFuZCAoY29tbWFuZDogQXNzZXJ0aW9uQ29tbWFuZCk6IHZvaWQge1xuICAgICAgICBjb21tYW5kLmlkID0gZ2VuZXJhdGVVbmlxdWVJZCgpO1xuXG4gICAgICAgIHRoaXMuYXNzZXJ0aW9uQ29tbWFuZHMuc2V0KGNvbW1hbmQuaWQsIGNvbW1hbmQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX3N0b3JlU3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmQgKGNvbW1hbmQ6IFN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kKTogdm9pZCB7XG4gICAgICAgIGNvbW1hbmQuaWQgPSBnZW5lcmF0ZVVuaXF1ZUlkKCk7XG5cbiAgICAgICAgdGhpcy5zd2l0Y2hUb1dpbmRvd0J5UHJlZGljYXRlQ29tbWFuZHMuc2V0KGNvbW1hbmQuaWQsIGNvbW1hbmQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2hhbmRsZUFzc2VydGlvbkNvbW1hbmQgKGNvbW1hbmQ6IEFzc2VydGlvbkNvbW1hbmQpOiB2b2lkIHtcbiAgICAgICAgaWYgKGlzRnVuY3Rpb24oY29tbWFuZC5hY3R1YWwpKSB7XG4gICAgICAgICAgICBjb21tYW5kLm9yaWdpbkFjdHVhbCA9IGNvbW1hbmQuYWN0dWFsO1xuICAgICAgICAgICAgY29tbWFuZC5hY3R1YWwgICAgICAgPSBuZXcgRnVuY3Rpb25NYXJrZXIoKTtcblxuICAgICAgICAgICAgdGhpcy5fc3RvcmVBc3NlcnRpb25Db21tYW5kKGNvbW1hbmQpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGNvbW1hbmQuYWN0dWFsIGluc3RhbmNlb2YgUmVFeGVjdXRhYmxlUHJvbWlzZSlcbiAgICAgICAgICAgIHRoaXMuX3N0b3JlQXNzZXJ0aW9uQ29tbWFuZChjb21tYW5kKTtcblxuICAgICAgICBlbHNlIGlmIChpc1RoZW5uYWJsZShjb21tYW5kLmFjdHVhbCkpIHtcbiAgICAgICAgICAgIGNvbW1hbmQub3JpZ2luQWN0dWFsID0gY29tbWFuZC5hY3R1YWw7XG4gICAgICAgICAgICBjb21tYW5kLmFjdHVhbCAgICAgICA9IG5ldyBQcm9taXNlTWFya2VyKCk7XG5cbiAgICAgICAgICAgIHRoaXMuX3N0b3JlQXNzZXJ0aW9uQ29tbWFuZChjb21tYW5kKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgX2hhbmRsZUV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmRCYXNlIChjb21tYW5kOiBFeGVjdXRlQ2xpZW50RnVuY3Rpb25Db21tYW5kQmFzZSk6IHZvaWQge1xuICAgICAgICBjb21tYW5kLmVzbVJ1bnRpbWUgPSB0aGlzLnRlc3QuZXNtUnVudGltZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9zdG9yZUFjdGlvbkNhbGxzaXRlc0ZvckV4ZWN1dGVkQXN5bmNKc0V4cHJlc3Npb24gKGNhbGxzaXRlOiBDYWxsc2l0ZVJlY29yZCk6IHZvaWQge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGlmIChjYWxsc2l0ZT8uZmlsZW5hbWUgIT09IEVSUk9SX0ZJTEVOQU1FKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IGlkID0gZ2VuZXJhdGVVbmlxdWVJZCgpO1xuXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgY2FsbHNpdGUuaWQgPSBpZDtcblxuICAgICAgICB0aGlzLmFzeW5jSnNFeHByZXNzaW9uQ2FsbHNpdGVzLnNldChpZCwgY2FsbHNpdGUgYXMgQ2FsbHNpdGVSZWNvcmQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBleGVjdXRlQ29tbWFuZCAoY29tbWFuZDogQ29tbWFuZEJhc2UgfCBBY3Rpb25Db21tYW5kQmFzZSwgY2FsbHNpdGU/OiBDYWxsc2l0ZVJlY29yZCB8IHN0cmluZyk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICBpZiAoY29tbWFuZCBpbnN0YW5jZW9mIEFjdGlvbkNvbW1hbmRCYXNlICYmIGNhbGxzaXRlKVxuICAgICAgICAgICAgdGhpcy5fc3RvcmVBY3Rpb25DYWxsc2l0ZXNGb3JFeGVjdXRlZEFzeW5jSnNFeHByZXNzaW9uKGNhbGxzaXRlIGFzIENhbGxzaXRlUmVjb3JkKTtcblxuICAgICAgICBpZiAoY29tbWFuZC50eXBlID09PSBDT01NQU5EX1RZUEUuYXNzZXJ0aW9uKVxuICAgICAgICAgICAgdGhpcy5faGFuZGxlQXNzZXJ0aW9uQ29tbWFuZChjb21tYW5kIGFzIEFzc2VydGlvbkNvbW1hbmQpO1xuICAgICAgICBlbHNlIGlmIChjb21tYW5kLnR5cGUgPT09IENPTU1BTkRfVFlQRS51c2VSb2xlKVxuICAgICAgICAgICAgdGhpcy5kaXNwYXRjaGVyLm9uUm9sZUFwcGVhcmVkKChjb21tYW5kIGFzIFVzZVJvbGVDb21tYW5kKS5yb2xlKTtcbiAgICAgICAgZWxzZSBpZiAoY29tbWFuZC50eXBlID09PSBDT01NQU5EX1RZUEUuc3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZSlcbiAgICAgICAgICAgIHRoaXMuX3N0b3JlU3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmQoY29tbWFuZCBhcyBTd2l0Y2hUb1dpbmRvd0J5UHJlZGljYXRlQ29tbWFuZCk7XG4gICAgICAgIGVsc2UgaWYgKGNvbW1hbmQgaW5zdGFuY2VvZiBFeGVjdXRlQ2xpZW50RnVuY3Rpb25Db21tYW5kQmFzZSlcbiAgICAgICAgICAgIHRoaXMuX2hhbmRsZUV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmRCYXNlKGNvbW1hbmQpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoZXIuZXhlY3V0ZUNvbW1hbmQoe1xuICAgICAgICAgICAgY29tbWFuZCxcbiAgICAgICAgICAgIGNhbGxzaXRlLFxuICAgICAgICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBleGVjdXRlQ29tbWFuZFN5bmMgKGNvbW1hbmQ6IENvbW1hbmRCYXNlLCBjYWxsc2l0ZTogQ2FsbHNpdGVSZWNvcmQpOiB1bmtub3duIHtcbiAgICAgICAgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLmFzc2VydGlvbilcbiAgICAgICAgICAgIHRoaXMuX2hhbmRsZUFzc2VydGlvbkNvbW1hbmQoY29tbWFuZCBhcyBBc3NlcnRpb25Db21tYW5kKTtcbiAgICAgICAgZWxzZSBpZiAoY29tbWFuZC50eXBlID09PSBDT01NQU5EX1RZUEUudXNlUm9sZSlcbiAgICAgICAgICAgIHRoaXMuZGlzcGF0Y2hlci5vblJvbGVBcHBlYXJlZCgoY29tbWFuZCBhcyBVc2VSb2xlQ29tbWFuZCkucm9sZSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZGlzcGF0Y2hlci5leGVjdXRlQ29tbWFuZFN5bmMoe1xuICAgICAgICAgICAgY29tbWFuZCxcbiAgICAgICAgICAgIGNhbGxzaXRlLFxuICAgICAgICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBhZGRSZXF1ZXN0SG9vayAoaG9vazogUmVxdWVzdEhvb2spOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKHRoaXMudGVzdC5yZXF1ZXN0SG9va3MuaW5jbHVkZXMoaG9vaykpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy50ZXN0LnJlcXVlc3RIb29rcy5wdXNoKGhvb2spO1xuICAgICAgICB0aGlzLl9hdHRhY2hXYXJuaW5nTG9nKGhvb2spO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuZGlzcGF0Y2hlci5hZGRSZXF1ZXN0RXZlbnRMaXN0ZW5lcnMoe1xuICAgICAgICAgICAgaG9va0lkOiAgICAgICAgaG9vay5pZCxcbiAgICAgICAgICAgIGhvb2tDbGFzc05hbWU6IGhvb2suX2NsYXNzTmFtZSxcbiAgICAgICAgICAgIHJ1bGVzOiAgICAgICAgIGhvb2suX3JlcXVlc3RGaWx0ZXJSdWxlcyxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHJlbW92ZVJlcXVlc3RIb29rIChob29rOiBSZXF1ZXN0SG9vayk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBpZiAoIXRoaXMudGVzdC5yZXF1ZXN0SG9va3MuaW5jbHVkZXMoaG9vaykpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgcHVsbCh0aGlzLnRlc3QucmVxdWVzdEhvb2tzLCBob29rKTtcbiAgICAgICAgdGhpcy5fZGV0YWNoV2FybmluZ0xvZyhob29rKTtcblxuICAgICAgICBhd2FpdCB0aGlzLmRpc3BhdGNoZXIucmVtb3ZlUmVxdWVzdEV2ZW50TGlzdGVuZXJzKHsgcnVsZXM6IGhvb2suX3JlcXVlc3RGaWx0ZXJSdWxlcyB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZ2V0QXNzZXJ0aW9uQWN0dWFsVmFsdWUgKGNvbW1hbmRJZDogc3RyaW5nKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0aGlzLmFzc2VydGlvbkNvbW1hbmRzLmdldChjb21tYW5kSWQpIGFzIEFzc2VydGlvbkNvbW1hbmQ7XG5cbiAgICAgICAgcmV0dXJuIChjb21tYW5kLmFjdHVhbCBhcyBSZUV4ZWN1dGFibGVQcm9taXNlKS5fcmVFeGVjdXRlKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVBc3NlcnRpb25GbiAoY29tbWFuZElkOiBzdHJpbmcpOiBQcm9taXNlPHVua25vd24+IHtcbiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuYXNzZXJ0aW9uQ29tbWFuZHMuZ2V0KGNvbW1hbmRJZCkgYXMgQXNzZXJ0aW9uQ29tbWFuZDtcblxuICAgICAgICBjb21tYW5kLmFjdHVhbCA9IGNvbW1hbmQub3JpZ2luQWN0dWFsO1xuXG4gICAgICAgIGNvbnN0IGZuID0gZ2V0Rm4oY29tbWFuZCk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IGZuKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHJlc3RvcmVPcmlnaW5DYWxsc2l0ZUZvckVycm9yIChlcnI6IFVuY2F1Z2h0VGVzdENhZmVFcnJvckluQ3VzdG9tU2NyaXB0KTogdm9pZCB7XG4gICAgICAgIGVyci5lcnJDYWxsc2l0ZSA9IHRoaXMuYXN5bmNKc0V4cHJlc3Npb25DYWxsc2l0ZXMuZ2V0KGVyci5lcnJDYWxsc2l0ZS5pZCk7XG5cbiAgICAgICAgdGhpcy5hc3luY0pzRXhwcmVzc2lvbkNhbGxzaXRlcy5jbGVhcigpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjaGVja1dpbmRvdyAoY29tbWFuZElkOiBzdHJpbmcsIHsgdGl0bGUsIHVybCB9OiBDaGVja1dpbmRvd1ByZWRpY2F0ZURhdGEpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuc3dpdGNoVG9XaW5kb3dCeVByZWRpY2F0ZUNvbW1hbmRzLmdldChjb21tYW5kSWQpIGFzIFN3aXRjaFRvV2luZG93QnlQcmVkaWNhdGVDb21tYW5kO1xuXG4gICAgICAgIHJldHVybiBjb21tYW5kLmNoZWNrV2luZG93KHsgdGl0bGUsIHVybCB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaXNOYXRpdmVBdXRvbWF0aW9uICgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzTmF0aXZlQXV0b21hdGlvbjtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFRlc3RSdW5Qcm94eTtcblxuXG4iXX0=