"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createRequestOptions = void 0;
const lodash_1 = require("lodash");
const is_stream_1 = __importDefault(require("is-stream"));
const interfaces_1 = require("./interfaces");
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const content_types_1 = __importDefault(require("../../assets/content-types"));
const http_headers_1 = __importDefault(require("../../utils/http-headers"));
const types_1 = require("../../errors/types");
const runtime_1 = require("../../errors/runtime");
const actions_1 = require("../commands/actions");
const DEFAULT_ACCEPT = { [http_headers_1.default.accept]: `${content_types_1.default.json}, ${content_types_1.default.textPlain}, ${content_types_1.default.all}` };
const METHODS_WITH_CONTENT_TYPE = ['POST', 'PUT', 'PATCH'];
const DEFAULT_REQUEST_METHOD = 'GET';
const DEFAULT_PROTOCOL = 'http:';
function setContentTypeIfNotExists(headers, value) {
    if (!(0, lodash_1.isUndefined)(headers) && (0, lodash_1.isUndefined)(headers[http_headers_1.default.contentType]))
        headers[http_headers_1.default.contentType] = value;
}
function typeOf(value) {
    if (value === null)
        return 'null';
    if (value && typeof value === 'object')
        return value.constructor.name.toLowerCase();
    return typeof value;
}
function transformBody(headers, body) {
    if (!body)
        return Buffer.from('');
    if (typeOf(body) === 'formdata' ||
        typeOf(body) === 'file' ||
        typeOf(body) === 'blob' ||
        (0, lodash_1.isArrayBuffer)(body) ||
        (0, lodash_1.isBuffer)(body) ||
        (0, is_stream_1.default)(body))
        return Buffer.from(body);
    else if (ArrayBuffer.isView(body))
        return Buffer.from(body.buffer);
    else if (body instanceof URLSearchParams) {
        setContentTypeIfNotExists(headers, `${content_types_1.default.urlencoded};charset=utf-8`);
        return Buffer.from(body.toString());
    }
    else if ((0, lodash_1.isObject)(body) || headers && headers[http_headers_1.default.contentType] === content_types_1.default.json) {
        setContentTypeIfNotExists(headers, content_types_1.default.json);
        return Buffer.from(JSON.stringify(body));
    }
    else if (typeof body === 'string')
        setContentTypeIfNotExists(headers, content_types_1.default.textPlain);
    return body;
}
function getAuthString(auth) {
    return 'Basic ' + Buffer.from(auth.username + ':' + auth.password, 'utf8').toString('base64');
}
function changeHeaderNamesToLowercase(headers) {
    const lowerCaseHeaders = {};
    Object.keys(headers).forEach(headerName => {
        lowerCaseHeaders[headerName.toLowerCase()] = headers[headerName];
    });
    return lowerCaseHeaders;
}
async function prepareHeaders(options, currentPageUrl, url, body, testRun, withCredentials) {
    const { host, origin } = url;
    const { method, proxy, auth, headers = {} } = options;
    const preparedHeaders = Object.assign({}, DEFAULT_ACCEPT, changeHeaderNamesToLowercase(headers));
    preparedHeaders[http_headers_1.default.host] = host;
    preparedHeaders[http_headers_1.default.origin] = origin;
    preparedHeaders[http_headers_1.default.contentLength] = body.length;
    if (method && METHODS_WITH_CONTENT_TYPE.includes(String(method)))
        preparedHeaders[http_headers_1.default.contentType] = preparedHeaders[http_headers_1.default.contentType] || content_types_1.default.urlencoded;
    if (auth && withCredentials)
        preparedHeaders[http_headers_1.default.authorization] = getAuthString(auth);
    if (proxy === null || proxy === void 0 ? void 0 : proxy.auth)
        preparedHeaders[http_headers_1.default.proxyAuthorization] = getAuthString(proxy.auth);
    if (withCredentials) {
        const currentPageCookies = await testRun.cookieProvider.getCookieHeader(currentPageUrl.href, currentPageUrl.hostname);
        if (currentPageCookies)
            preparedHeaders[http_headers_1.default.cookie] = currentPageCookies;
    }
    //NOTE: Additional header to recognize API requests in the hammerhead
    preparedHeaders[http_headers_1.default.isApiRequest] = 'true';
    return preparedHeaders;
}
async function prepareUrl(testRun, currentPageUrl, url, callsite) {
    let preparedUrl;
    try {
        preparedUrl = url instanceof URL
            ? url
            : new URL(url, currentPageUrl.hostname ? currentPageUrl.origin : void 0);
    }
    catch (e) {
        throw new runtime_1.APIError(callsite, types_1.RUNTIME_ERRORS.requestUrlInvalidValueError, url);
    }
    return preparedUrl;
}
function prepareSearchParams(url, params) {
    if (!params)
        return url;
    let searchParams;
    if (params instanceof URLSearchParams)
        searchParams = params;
    else {
        searchParams = new URLSearchParams();
        for (const key in params) {
            if (!params[key])
                continue;
            (0, lodash_1.castArray)(params[key]).forEach(v => {
                searchParams.append(key, typeof v === 'object' ? JSON.stringify(v) : String(v));
            });
        }
    }
    return `${url}${url.includes('?') ? '&' : '?'}${searchParams.toString()}`;
}
function getProxyUrl(testRun, url, withCredentials) {
    return testRun.executeCommand(new actions_1.GetProxyUrlCommand({
        url: url,
        options: { credentials: withCredentials ? interfaces_1.Credentials.include : interfaces_1.Credentials.omit },
    }, testRun, true));
}
async function resolveNativeAutomationUrlParts(url) {
    const { href, hostname, port, pathname, search, protocol, } = url;
    const partAfterHost = [pathname, search].join('');
    return { partAfterHost, href, hostname, port, protocol };
}
async function resolvePoxyUrlParts(testRun, url, withCredentials) {
    const href = await getProxyUrl(testRun, url.href, withCredentials);
    const urlObj = await (0, testcafe_hammerhead_1.parseProxyUrl)(href);
    const { partAfterHost } = urlObj;
    const { hostname, port } = urlObj.proxy;
    return { partAfterHost, href, hostname, port, protocol: DEFAULT_PROTOCOL };
}
function resolveUrlParts(testRun, url, withCredentials) {
    return testRun.isNativeAutomation() ? resolveNativeAutomationUrlParts(url) : resolvePoxyUrlParts(testRun, url, withCredentials);
}
async function createRequestOptions(currentPageUrl, testRun, options, callsite) {
    var _a;
    options.headers = options.headers || {};
    options.method = ((_a = options.method) === null || _a === void 0 ? void 0 : _a.toUpperCase()) || DEFAULT_REQUEST_METHOD;
    const url = await prepareUrl(testRun, currentPageUrl, options.url, callsite);
    const withCredentials = !currentPageUrl.host || (0, testcafe_hammerhead_1.sameOriginCheck)(currentPageUrl.href, url.href) || options.withCredentials || false;
    const body = transformBody(options.headers, options.body);
    const headers = await prepareHeaders(options, currentPageUrl, url, body, testRun, withCredentials);
    let auth = options.auth;
    const { hostname, port, href, partAfterHost, protocol, } = await resolveUrlParts(testRun, url, withCredentials);
    if (!auth && url.username && url.password) {
        auth = {
            username: url.username,
            password: url.password,
        };
    }
    const requestParams = {
        method: options.method,
        url: href,
        protocol: protocol,
        hostname: hostname,
        host: hostname,
        port: port,
        path: prepareSearchParams(partAfterHost, options.params),
        auth: auth && withCredentials ? `${auth.username}:${auth.password}` : void 0,
        headers: headers,
        credentials: withCredentials ? testRun.session.getAuthCredentials() : void 0,
        body: body,
        disableHttp2: testRun.session.isHttp2Disabled(),
        requestTimeout: {
            ajax: options.timeout,
            page: options.timeout,
        },
    };
    if (options.proxy) {
        requestParams.externalProxySettings = {
            host: options.proxy.host,
            hostname: options.proxy.host,
            port: options.proxy.port.toString(),
            proxyAuth: options.proxy.auth ? `${options.proxy.auth.username}:${options.proxy.auth.password}` : void 0,
        };
        requestParams.protocol = url.protocol;
        requestParams.host = url.host;
        requestParams.hostname = url.hostname;
        requestParams.port = url.port;
        requestParams.path = prepareSearchParams(url.pathname + url.search, options.params);
    }
    return new testcafe_hammerhead_1.RequestOptions(requestParams);
}
exports.createRequestOptions = createRequestOptions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLXJlcXVlc3Qtb3B0aW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90ZXN0LXJ1bi9yZXF1ZXN0L2NyZWF0ZS1yZXF1ZXN0LW9wdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsbUNBTWdCO0FBQ2hCLDBEQUFpQztBQUNqQyw2Q0FLc0I7QUFDdEIsNkRBSzZCO0FBRTdCLCtFQUF1RDtBQUN2RCw0RUFBb0Q7QUFDcEQsOENBQW9EO0FBQ3BELGtEQUFnRDtBQUNoRCxpREFBeUQ7QUFHekQsTUFBTSxjQUFjLEdBQWMsRUFBRSxDQUFDLHNCQUFZLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyx1QkFBYSxDQUFDLElBQUksS0FBSyx1QkFBYSxDQUFDLFNBQVMsS0FBSyx1QkFBYSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7QUFDdkksTUFBTSx5QkFBeUIsR0FBRyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDM0QsTUFBTSxzQkFBc0IsR0FBTSxLQUFLLENBQUM7QUFDeEMsTUFBTSxnQkFBZ0IsR0FBWSxPQUFPLENBQUM7QUFFMUMsU0FBUyx5QkFBeUIsQ0FBRSxPQUE0QixFQUFFLEtBQWE7SUFDM0UsSUFBSSxDQUFDLElBQUEsb0JBQVcsRUFBQyxPQUFPLENBQUMsSUFBSSxJQUFBLG9CQUFXLEVBQUMsT0FBTyxDQUFDLHNCQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDdkUsT0FBTyxDQUFDLHNCQUFZLENBQUMsV0FBVyxDQUFDLEdBQUcsS0FBSyxDQUFDO0FBQ2xELENBQUM7QUFFRCxTQUFTLE1BQU0sQ0FBRSxLQUFjO0lBQzNCLElBQUksS0FBSyxLQUFLLElBQUk7UUFDZCxPQUFPLE1BQU0sQ0FBQztJQUVsQixJQUFJLEtBQUssSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRO1FBQ2xDLE9BQU8sS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FB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WUFDckIsSUFBSSxFQUFFLE9BQU8sQ0FBQyxPQUFPO1NBQ3hCO0tBQ0osQ0FBQztJQUVGLElBQUksT0FBTyxDQUFDLEtBQUssRUFBRTtRQUNmLGFBQWEsQ0FBQyxxQkFBcUIsR0FBRztZQUNsQyxJQUFJLEVBQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJO1lBQzdCLFFBQVEsRUFBRyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUk7WUFDN0IsSUFBSSxFQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUN4QyxTQUFTLEVBQUUsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7U0FDM0csQ0FBQztRQUVGLGFBQWEsQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQztRQUN0QyxhQUFhLENBQUMsSUFBSSxHQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDbEMsYUFBYSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQ3RDLGFBQWEsQ0FBQyxJQUFJLEdBQU8sR0FBRyxDQUFDLElBQUksQ0FBQztRQUNsQyxhQUFhLENBQUMsSUFBSSxHQUFPLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7S0FDM0Y7SUFFRCxPQUFPLElBQUksb0NBQWMsQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUM3QyxDQUFDO0FBNURELG9EQTREQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE91dGdvaW5nSHR0cEhlYWRlcnMgfSBmcm9tICdodHRwJztcbmltcG9ydCB7XG4gICAgY2FzdEFycmF5LFxuICAgIGlzQXJyYXlCdWZmZXIsXG4gICAgaXNCdWZmZXIsXG4gICAgaXNPYmplY3QsXG4gICAgaXNVbmRlZmluZWQsXG59IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgaXNTdHJlYW0gZnJvbSAnaXMtc3RyZWFtJztcbmltcG9ydCB7XG4gICAgQXV0aE9wdGlvbnMsXG4gICAgQ3JlZGVudGlhbHMsXG4gICAgRXh0ZXJuYWxSZXF1ZXN0T3B0aW9ucyxcbiAgICBQYXJhbXMsXG59IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5pbXBvcnQge1xuICAgIFJlcXVlc3RPcHRpb25zLFxuICAgIHBhcnNlUHJveHlVcmwsXG4gICAgUmVxdWVzdE9wdGlvbnNQYXJhbXMsXG4gICAgc2FtZU9yaWdpbkNoZWNrLFxufSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcbmltcG9ydCBUZXN0UnVuIGZyb20gJy4uL2luZGV4JztcbmltcG9ydCBDT05URU5UX1RZUEVTIGZyb20gJy4uLy4uL2Fzc2V0cy9jb250ZW50LXR5cGVzJztcbmltcG9ydCBIVFRQX0hFQURFUlMgZnJvbSAnLi4vLi4vdXRpbHMvaHR0cC1oZWFkZXJzJztcbmltcG9ydCB7IFJVTlRJTUVfRVJST1JTIH0gZnJvbSAnLi4vLi4vZXJyb3JzL3R5cGVzJztcbmltcG9ydCB7IEFQSUVycm9yIH0gZnJvbSAnLi4vLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IHsgR2V0UHJveHlVcmxDb21tYW5kIH0gZnJvbSAnLi4vY29tbWFuZHMvYWN0aW9ucyc7XG5pbXBvcnQgeyBDYWxsc2l0ZVJlY29yZCB9IGZyb20gJ2NhbGxzaXRlLXJlY29yZCc7XG5cbmNvbnN0IERFRkFVTFRfQUNDRVBUICAgICAgICAgICAgPSB7IFtIVFRQX0hFQURFUlMuYWNjZXB0XTogYCR7Q09OVEVOVF9UWVBFUy5qc29ufSwgJHtDT05URU5UX1RZUEVTLnRleHRQbGFpbn0sICR7Q09OVEVOVF9UWVBFUy5hbGx9YCB9O1xuY29uc3QgTUVUSE9EU19XSVRIX0NPTlRFTlRfVFlQRSA9IFsnUE9TVCcsICdQVVQnLCAnUEFUQ0gnXTtcbmNvbnN0IERFRkFVTFRfUkVRVUVTVF9NRVRIT0QgICAgPSAnR0VUJztcbmNvbnN0IERFRkFVTFRfUFJPVE9DT0wgICAgICAgICAgPSAnaHR0cDonO1xuXG5mdW5jdGlvbiBzZXRDb250ZW50VHlwZUlmTm90RXhpc3RzIChoZWFkZXJzOiBPdXRnb2luZ0h0dHBIZWFkZXJzLCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKCFpc1VuZGVmaW5lZChoZWFkZXJzKSAmJiBpc1VuZGVmaW5lZChoZWFkZXJzW0hUVFBfSEVBREVSUy5jb250ZW50VHlwZV0pKVxuICAgICAgICBoZWFkZXJzW0hUVFBfSEVBREVSUy5jb250ZW50VHlwZV0gPSB2YWx1ZTtcbn1cblxuZnVuY3Rpb24gdHlwZU9mICh2YWx1ZTogdW5rbm93bik6IHN0cmluZyB7XG4gICAgaWYgKHZhbHVlID09PSBudWxsKVxuICAgICAgICByZXR1cm4gJ251bGwnO1xuXG4gICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpXG4gICAgICAgIHJldHVybiB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lLnRvTG93ZXJDYXNlKCk7XG5cbiAgICByZXR1cm4gdHlwZW9mIHZhbHVlO1xufVxuXG5mdW5jdGlvbiB0cmFuc2Zvcm1Cb2R5IChoZWFkZXJzOiBPdXRnb2luZ0h0dHBIZWFkZXJzLCBib2R5PzogYW55KTogQnVmZmVyIHtcbiAgICBpZiAoIWJvZHkpXG4gICAgICAgIHJldHVybiBCdWZmZXIuZnJvbSgnJyk7XG5cbiAgICBpZiAodHlwZU9mKGJvZHkpID09PSAnZm9ybWRhdGEnIHx8XG4gICAgICAgIHR5cGVPZihib2R5KSA9PT0gJ2ZpbGUnIHx8XG4gICAgICAgIHR5cGVPZihib2R5KSA9PT0gJ2Jsb2InIHx8XG4gICAgICAgIGlzQXJyYXlCdWZmZXIoYm9keSkgfHxcbiAgICAgICAgaXNCdWZmZXIoYm9keSkgfHxcbiAgICAgICAgaXNTdHJlYW0oYm9keSlcbiAgICApXG4gICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShib2R5KTtcbiAgICBlbHNlIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoYm9keSkpXG4gICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShib2R5LmJ1ZmZlcik7XG5cbiAgICBlbHNlIGlmIChib2R5IGluc3RhbmNlb2YgVVJMU2VhcmNoUGFyYW1zKSB7XG4gICAgICAgIHNldENvbnRlbnRUeXBlSWZOb3RFeGlzdHMoaGVhZGVycywgYCR7Q09OVEVOVF9UWVBFUy51cmxlbmNvZGVkfTtjaGFyc2V0PXV0Zi04YCk7XG5cbiAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGJvZHkudG9TdHJpbmcoKSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGlzT2JqZWN0KGJvZHkpIHx8IGhlYWRlcnMgJiYgaGVhZGVyc1tIVFRQX0hFQURFUlMuY29udGVudFR5cGVdID09PSBDT05URU5UX1RZUEVTLmpzb24pIHtcbiAgICAgICAgc2V0Q29udGVudFR5cGVJZk5vdEV4aXN0cyhoZWFkZXJzLCBDT05URU5UX1RZUEVTLmpzb24pO1xuXG4gICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShib2R5KSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKHR5cGVvZiBib2R5ID09PSAnc3RyaW5nJylcbiAgICAgICAgc2V0Q29udGVudFR5cGVJZk5vdEV4aXN0cyhoZWFkZXJzLCBDT05URU5UX1RZUEVTLnRleHRQbGFpbik7XG5cbiAgICByZXR1cm4gYm9keTtcbn1cblxuZnVuY3Rpb24gZ2V0QXV0aFN0cmluZyAoYXV0aDogQXV0aE9wdGlvbnMpOiBzdHJpbmcge1xuICAgIHJldHVybiAnQmFzaWMgJyArIEJ1ZmZlci5mcm9tKGF1dGgudXNlcm5hbWUgKyAnOicgKyBhdXRoLnBhc3N3b3JkLCAndXRmOCcpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbn1cblxuZnVuY3Rpb24gY2hhbmdlSGVhZGVyTmFtZXNUb0xvd2VyY2FzZSAoaGVhZGVyczogT3V0Z29pbmdIdHRwSGVhZGVycyk6IE91dGdvaW5nSHR0cEhlYWRlcnMge1xuICAgIGNvbnN0IGxvd2VyQ2FzZUhlYWRlcnM6IE91dGdvaW5nSHR0cEhlYWRlcnMgPSB7fTtcblxuICAgIE9iamVjdC5rZXlzKGhlYWRlcnMpLmZvckVhY2goaGVhZGVyTmFtZSA9PiB7XG4gICAgICAgIGxvd2VyQ2FzZUhlYWRlcnNbaGVhZGVyTmFtZS50b0xvd2VyQ2FzZSgpXSA9IGhlYWRlcnNbaGVhZGVyTmFtZV07XG4gICAgfSk7XG5cbiAgICByZXR1cm4gbG93ZXJDYXNlSGVhZGVycztcbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJlcGFyZUhlYWRlcnMgKG9wdGlvbnM6IEV4dGVybmFsUmVxdWVzdE9wdGlvbnMsIGN1cnJlbnRQYWdlVXJsOiBVUkwsIHVybDogVVJMLCBib2R5OiBCdWZmZXIsIHRlc3RSdW46IFRlc3RSdW4sIHdpdGhDcmVkZW50aWFsczogYm9vbGVhbik6IFByb21pc2U8T3V0Z29pbmdIdHRwSGVhZGVycz4ge1xuICAgIGNvbnN0IHsgaG9zdCwgb3JpZ2luIH0gICAgICAgICAgICAgICAgICAgICAgPSB1cmw7XG4gICAgY29uc3QgeyBtZXRob2QsIHByb3h5LCBhdXRoLCBoZWFkZXJzID0ge30gfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgcHJlcGFyZWRIZWFkZXJzOiBPdXRnb2luZ0h0dHBIZWFkZXJzICA9IE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfQUNDRVBULCBjaGFuZ2VIZWFkZXJOYW1lc1RvTG93ZXJjYXNlKGhlYWRlcnMpKTtcblxuICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMuaG9zdF0gICAgICAgICAgPSBob3N0O1xuICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMub3JpZ2luXSAgICAgICAgPSBvcmlnaW47XG4gICAgcHJlcGFyZWRIZWFkZXJzW0hUVFBfSEVBREVSUy5jb250ZW50TGVuZ3RoXSA9IGJvZHkubGVuZ3RoO1xuXG4gICAgaWYgKG1ldGhvZCAmJiBNRVRIT0RTX1dJVEhfQ09OVEVOVF9UWVBFLmluY2x1ZGVzKFN0cmluZyhtZXRob2QpKSlcbiAgICAgICAgcHJlcGFyZWRIZWFkZXJzW0hUVFBfSEVBREVSUy5jb250ZW50VHlwZV0gPSBwcmVwYXJlZEhlYWRlcnNbSFRUUF9IRUFERVJTLmNvbnRlbnRUeXBlXSB8fCBDT05URU5UX1RZUEVTLnVybGVuY29kZWQ7XG5cbiAgICBpZiAoYXV0aCAmJiB3aXRoQ3JlZGVudGlhbHMpXG4gICAgICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMuYXV0aG9yaXphdGlvbl0gPSBnZXRBdXRoU3RyaW5nKGF1dGgpO1xuXG4gICAgaWYgKHByb3h5Py5hdXRoKVxuICAgICAgICBwcmVwYXJlZEhlYWRlcnNbSFRUUF9IRUFERVJTLnByb3h5QXV0aG9yaXphdGlvbl0gPSBnZXRBdXRoU3RyaW5nKHByb3h5LmF1dGgpO1xuXG4gICAgaWYgKHdpdGhDcmVkZW50aWFscykge1xuICAgICAgICBjb25zdCBjdXJyZW50UGFnZUNvb2tpZXMgPSBhd2FpdCB0ZXN0UnVuLmNvb2tpZVByb3ZpZGVyLmdldENvb2tpZUhlYWRlcihjdXJyZW50UGFnZVVybC5ocmVmLCBjdXJyZW50UGFnZVVybC5ob3N0bmFtZSk7XG5cbiAgICAgICAgaWYgKGN1cnJlbnRQYWdlQ29va2llcylcbiAgICAgICAgICAgIHByZXBhcmVkSGVhZGVyc1tIVFRQX0hFQURFUlMuY29va2llXSA9IGN1cnJlbnRQYWdlQ29va2llcztcbiAgICB9XG5cbiAgICAvL05PVEU6IEFkZGl0aW9uYWwgaGVhZGVyIHRvIHJlY29nbml6ZSBBUEkgcmVxdWVzdHMgaW4gdGhlIGhhbW1lcmhlYWRcbiAgICBwcmVwYXJlZEhlYWRlcnNbSFRUUF9IRUFERVJTLmlzQXBpUmVxdWVzdF0gPSAndHJ1ZSc7XG5cbiAgICByZXR1cm4gcHJlcGFyZWRIZWFkZXJzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwcmVwYXJlVXJsICh0ZXN0UnVuOiBUZXN0UnVuLCBjdXJyZW50UGFnZVVybDogVVJMLCB1cmw6IHN0cmluZyB8IFVSTCwgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkIHwgbnVsbCk6IFByb21pc2U8VVJMPiB7XG4gICAgbGV0IHByZXBhcmVkVXJsOiBVUkw7XG5cbiAgICB0cnkge1xuICAgICAgICBwcmVwYXJlZFVybCA9IHVybCBpbnN0YW5jZW9mIFVSTFxuICAgICAgICAgICAgPyB1cmxcbiAgICAgICAgICAgIDogbmV3IFVSTCh1cmwsIGN1cnJlbnRQYWdlVXJsLmhvc3RuYW1lID8gY3VycmVudFBhZ2VVcmwub3JpZ2luIDogdm9pZCAwKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEFQSUVycm9yKGNhbGxzaXRlLCBSVU5USU1FX0VSUk9SUy5yZXF1ZXN0VXJsSW52YWxpZFZhbHVlRXJyb3IsIHVybCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHByZXBhcmVkVXJsO1xufVxuXG5mdW5jdGlvbiBwcmVwYXJlU2VhcmNoUGFyYW1zICh1cmw6IHN0cmluZywgcGFyYW1zPzogUGFyYW1zKTogc3RyaW5nIHtcbiAgICBpZiAoIXBhcmFtcylcbiAgICAgICAgcmV0dXJuIHVybDtcblxuICAgIGxldCBzZWFyY2hQYXJhbXM6IFVSTFNlYXJjaFBhcmFtcztcblxuICAgIGlmIChwYXJhbXMgaW5zdGFuY2VvZiBVUkxTZWFyY2hQYXJhbXMpXG4gICAgICAgIHNlYXJjaFBhcmFtcyA9IHBhcmFtcztcbiAgICBlbHNlIHtcbiAgICAgICAgc2VhcmNoUGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcygpO1xuXG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHBhcmFtcykge1xuICAgICAgICAgICAgaWYgKCFwYXJhbXNba2V5XSlcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcblxuICAgICAgICAgICAgY2FzdEFycmF5KHBhcmFtc1trZXldKS5mb3JFYWNoKHYgPT4ge1xuICAgICAgICAgICAgICAgIHNlYXJjaFBhcmFtcy5hcHBlbmQoa2V5LCB0eXBlb2YgdiA9PT0gJ29iamVjdCcgPyBKU09OLnN0cmluZ2lmeSh2KSA6IFN0cmluZyh2KSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBgJHt1cmx9JHt1cmwuaW5jbHVkZXMoJz8nKSA/ICcmJyA6ICc/J30ke3NlYXJjaFBhcmFtcy50b1N0cmluZygpfWA7XG59XG5cbmZ1bmN0aW9uIGdldFByb3h5VXJsICh0ZXN0UnVuOiBUZXN0UnVuLCB1cmw6IHN0cmluZywgd2l0aENyZWRlbnRpYWxzPzogYm9vbGVhbik6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRlc3RSdW4uZXhlY3V0ZUNvbW1hbmQobmV3IEdldFByb3h5VXJsQ29tbWFuZCh7XG4gICAgICAgIHVybDogICAgIHVybCxcbiAgICAgICAgb3B0aW9uczogeyBjcmVkZW50aWFsczogd2l0aENyZWRlbnRpYWxzID8gQ3JlZGVudGlhbHMuaW5jbHVkZSA6IENyZWRlbnRpYWxzLm9taXQgfSxcbiAgICB9LCB0ZXN0UnVuLCB0cnVlKSkgYXMgUHJvbWlzZTxzdHJpbmc+O1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXNvbHZlTmF0aXZlQXV0b21hdGlvblVybFBhcnRzICh1cmw6IFVSTCk6IFByb21pc2U8eyBob3N0bmFtZTogc3RyaW5nOyBwcm90b2NvbDogc3RyaW5nOyBwb3J0OiBzdHJpbmc7IGhyZWY6IHN0cmluZzsgcGFydEFmdGVySG9zdDogc3RyaW5nIH0+IHtcbiAgICBjb25zdCB7XG4gICAgICAgIGhyZWYsXG4gICAgICAgIGhvc3RuYW1lLFxuICAgICAgICBwb3J0LFxuICAgICAgICBwYXRobmFtZSxcbiAgICAgICAgc2VhcmNoLFxuICAgICAgICBwcm90b2NvbCxcbiAgICB9ID0gdXJsO1xuXG4gICAgY29uc3QgcGFydEFmdGVySG9zdCA9IFtwYXRobmFtZSwgc2VhcmNoXS5qb2luKCcnKTtcblxuICAgIHJldHVybiB7IHBhcnRBZnRlckhvc3QsIGhyZWYsIGhvc3RuYW1lLCBwb3J0LCBwcm90b2NvbCB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiByZXNvbHZlUG94eVVybFBhcnRzICh0ZXN0UnVuOiBUZXN0UnVuLCB1cmw6IFVSTCwgd2l0aENyZWRlbnRpYWxzOiBib29sZWFuKTogUHJvbWlzZTx7IGhvc3RuYW1lOiBzdHJpbmc7IHByb3RvY29sOiBzdHJpbmc7IHBvcnQ6IHN0cmluZzsgaHJlZjogc3RyaW5nOyBwYXJ0QWZ0ZXJIb3N0OiBzdHJpbmcgfT4ge1xuICAgIGNvbnN0IGhyZWYgICAgICAgICAgICAgICA9IGF3YWl0IGdldFByb3h5VXJsKHRlc3RSdW4sIHVybC5ocmVmLCB3aXRoQ3JlZGVudGlhbHMpO1xuICAgIGNvbnN0IHVybE9iaiAgICAgICAgICAgICA9IGF3YWl0IHBhcnNlUHJveHlVcmwoaHJlZik7XG4gICAgY29uc3QgeyBwYXJ0QWZ0ZXJIb3N0IH0gID0gdXJsT2JqO1xuICAgIGNvbnN0IHsgaG9zdG5hbWUsIHBvcnQgfSA9IHVybE9iai5wcm94eTtcblxuICAgIHJldHVybiB7IHBhcnRBZnRlckhvc3QsIGhyZWYsIGhvc3RuYW1lLCBwb3J0LCBwcm90b2NvbDogREVGQVVMVF9QUk9UT0NPTCB9O1xufVxuXG5mdW5jdGlvbiByZXNvbHZlVXJsUGFydHMgKHRlc3RSdW46IFRlc3RSdW4sIHVybDogVVJMLCB3aXRoQ3JlZGVudGlhbHM6IGJvb2xlYW4pOiBQcm9taXNlPHsgaG9zdG5hbWU6IHN0cmluZzsgcHJvdG9jb2w6IHN0cmluZzsgcG9ydDogc3RyaW5nOyBocmVmOiBzdHJpbmc7IHBhcnRBZnRlckhvc3Q6IHN0cmluZyB9PiB7XG4gICAgcmV0dXJuIHRlc3RSdW4uaXNOYXRpdmVBdXRvbWF0aW9uKCkgPyByZXNvbHZlTmF0aXZlQXV0b21hdGlvblVybFBhcnRzKHVybCkgOiByZXNvbHZlUG94eVVybFBhcnRzKHRlc3RSdW4sIHVybCwgd2l0aENyZWRlbnRpYWxzKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVJlcXVlc3RPcHRpb25zIChjdXJyZW50UGFnZVVybDogVVJMLCB0ZXN0UnVuOiBUZXN0UnVuLCBvcHRpb25zOiBFeHRlcm5hbFJlcXVlc3RPcHRpb25zLCBjYWxsc2l0ZTogQ2FsbHNpdGVSZWNvcmQgfCBudWxsKTogUHJvbWlzZTxSZXF1ZXN0T3B0aW9ucz4ge1xuICAgIG9wdGlvbnMuaGVhZGVycyA9IG9wdGlvbnMuaGVhZGVycyB8fCB7fTtcbiAgICBvcHRpb25zLm1ldGhvZCAgPSBvcHRpb25zLm1ldGhvZD8udG9VcHBlckNhc2UoKSB8fCBERUZBVUxUX1JFUVVFU1RfTUVUSE9EO1xuXG4gICAgY29uc3QgdXJsICAgICAgICAgICAgID0gYXdhaXQgcHJlcGFyZVVybCh0ZXN0UnVuLCBjdXJyZW50UGFnZVVybCwgb3B0aW9ucy51cmwsIGNhbGxzaXRlKTtcbiAgICBjb25zdCB3aXRoQ3JlZGVudGlhbHMgPSAhY3VycmVudFBhZ2VVcmwuaG9zdCB8fCBzYW1lT3JpZ2luQ2hlY2soY3VycmVudFBhZ2VVcmwuaHJlZiwgdXJsLmhyZWYpIHx8IG9wdGlvbnMud2l0aENyZWRlbnRpYWxzIHx8IGZhbHNlO1xuICAgIGNvbnN0IGJvZHkgICAgICAgICAgICA9IHRyYW5zZm9ybUJvZHkob3B0aW9ucy5oZWFkZXJzLCBvcHRpb25zLmJvZHkpO1xuICAgIGNvbnN0IGhlYWRlcnMgICAgICAgICA9IGF3YWl0IHByZXBhcmVIZWFkZXJzKG9wdGlvbnMsIGN1cnJlbnRQYWdlVXJsLCB1cmwsIGJvZHksIHRlc3RSdW4sIHdpdGhDcmVkZW50aWFscyk7XG4gICAgbGV0IGF1dGggICAgICAgICAgICAgID0gb3B0aW9ucy5hdXRoO1xuXG4gICAgY29uc3Qge1xuICAgICAgICBob3N0bmFtZSxcbiAgICAgICAgcG9ydCxcbiAgICAgICAgaHJlZixcbiAgICAgICAgcGFydEFmdGVySG9zdCxcbiAgICAgICAgcHJvdG9jb2wsXG4gICAgfSA9IGF3YWl0IHJlc29sdmVVcmxQYXJ0cyh0ZXN0UnVuLCB1cmwsIHdpdGhDcmVkZW50aWFscyk7XG5cbiAgICBpZiAoIWF1dGggJiYgdXJsLnVzZXJuYW1lICYmIHVybC5wYXNzd29yZCkge1xuICAgICAgICBhdXRoID0ge1xuICAgICAgICAgICAgdXNlcm5hbWU6IHVybC51c2VybmFtZSxcbiAgICAgICAgICAgIHBhc3N3b3JkOiB1cmwucGFzc3dvcmQsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgcmVxdWVzdFBhcmFtczogUmVxdWVzdE9wdGlvbnNQYXJhbXMgPSB7XG4gICAgICAgIG1ldGhvZDogICAgICAgICBvcHRpb25zLm1ldGhvZCxcbiAgICAgICAgdXJsOiAgICAgICAgICAgIGhyZWYsXG4gICAgICAgIHByb3RvY29sOiAgICAgICBwcm90b2NvbCxcbiAgICAgICAgaG9zdG5hbWU6ICAgICAgIGhvc3RuYW1lLFxuICAgICAgICBob3N0OiAgICAgICAgICAgaG9zdG5hbWUsXG4gICAgICAgIHBvcnQ6ICAgICAgICAgICBwb3J0LFxuICAgICAgICBwYXRoOiAgICAgICAgICAgcHJlcGFyZVNlYXJjaFBhcmFtcyhwYXJ0QWZ0ZXJIb3N0LCBvcHRpb25zLnBhcmFtcyksXG4gICAgICAgIGF1dGg6ICAgICAgICAgICBhdXRoICYmIHdpdGhDcmVkZW50aWFscyA/IGAke2F1dGgudXNlcm5hbWV9OiR7YXV0aC5wYXNzd29yZH1gIDogdm9pZCAwLFxuICAgICAgICBoZWFkZXJzOiAgICAgICAgaGVhZGVycyxcbiAgICAgICAgY3JlZGVudGlhbHM6ICAgIHdpdGhDcmVkZW50aWFscyA/IHRlc3RSdW4uc2Vzc2lvbi5nZXRBdXRoQ3JlZGVudGlhbHMoKSA6IHZvaWQgMCxcbiAgICAgICAgYm9keTogICAgICAgICAgIGJvZHksXG4gICAgICAgIGRpc2FibGVIdHRwMjogICB0ZXN0UnVuLnNlc3Npb24uaXNIdHRwMkRpc2FibGVkKCksXG4gICAgICAgIHJlcXVlc3RUaW1lb3V0OiB7XG4gICAgICAgICAgICBhamF4OiBvcHRpb25zLnRpbWVvdXQsXG4gICAgICAgICAgICBwYWdlOiBvcHRpb25zLnRpbWVvdXQsXG4gICAgICAgIH0sXG4gICAgfTtcblxuICAgIGlmIChvcHRpb25zLnByb3h5KSB7XG4gICAgICAgIHJlcXVlc3RQYXJhbXMuZXh0ZXJuYWxQcm94eVNldHRpbmdzID0ge1xuICAgICAgICAgICAgaG9zdDogICAgICBvcHRpb25zLnByb3h5Lmhvc3QsXG4gICAgICAgICAgICBob3N0bmFtZTogIG9wdGlvbnMucHJveHkuaG9zdCxcbiAgICAgICAgICAgIHBvcnQ6ICAgICAgb3B0aW9ucy5wcm94eS5wb3J0LnRvU3RyaW5nKCksXG4gICAgICAgICAgICBwcm94eUF1dGg6IG9wdGlvbnMucHJveHkuYXV0aCA/IGAke29wdGlvbnMucHJveHkuYXV0aC51c2VybmFtZX06JHtvcHRpb25zLnByb3h5LmF1dGgucGFzc3dvcmR9YCA6IHZvaWQgMCxcbiAgICAgICAgfTtcblxuICAgICAgICByZXF1ZXN0UGFyYW1zLnByb3RvY29sID0gdXJsLnByb3RvY29sO1xuICAgICAgICByZXF1ZXN0UGFyYW1zLmhvc3QgICAgID0gdXJsLmhvc3Q7XG4gICAgICAgIHJlcXVlc3RQYXJhbXMuaG9zdG5hbWUgPSB1cmwuaG9zdG5hbWU7XG4gICAgICAgIHJlcXVlc3RQYXJhbXMucG9ydCAgICAgPSB1cmwucG9ydDtcbiAgICAgICAgcmVxdWVzdFBhcmFtcy5wYXRoICAgICA9IHByZXBhcmVTZWFyY2hQYXJhbXModXJsLnBhdGhuYW1lICsgdXJsLnNlYXJjaCwgb3B0aW9ucy5wYXJhbXMpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgUmVxdWVzdE9wdGlvbnMocmVxdWVzdFBhcmFtcyk7XG59XG4iXX0=